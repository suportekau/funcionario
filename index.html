<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema Simples - Funcionários (Firebase + PWA)</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff"/>
<style>
  /* estilo simples e responsivo (uppercase visual) */
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    text-transform: uppercase;
    box-sizing: border-box;
  }
  .container {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    text-align: center;
    width: 100%;
    max-width: 380px;
    box-sizing: border-box;
  }
  h2 { margin-bottom: 20px; font-size: 1.4em; }
  input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; text-transform: uppercase; }
  button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; background-color: #007bff; color: white; font-size: 16px; cursor: pointer; transition: background 0.2s; }
  button:hover { background-color: #0056b3; }
  .btn-voltar { background-color: #6c757d; }
  .btn-voltar:hover { background-color: #565e64; }
  .hidden { display: none; }
  .lista { text-align: left; margin-top: 10px; max-height: 250px; overflow-y: auto; }
  .item { display: flex; justify-content: space-between; align-items: center; background: #f1f3f5; padding: 6px 8px; border-radius: 6px; margin: 4px 0; transition: background 0.2s; }
  .item:hover { background-color: #e0e3e7; }
  .btn-excluir { width: 28px; height: 28px; display:flex; align-items:center; justify-content:center; background-color:#dc3545; color:white; border:none; border-radius:50%; cursor:pointer; font-size:14px; flex-shrink:0; transition: background .2s, transform .1s; }
  .btn-excluir:hover{ background-color:#b02a37; transform: scale(1.1); }
  @media (max-width: 400px) {
    h2 { font-size: 1.2em; }
    button { font-size: 15px; padding: 10px; }
    input, select, textarea { font-size: 15px; padding: 8px; }
  }
  .small { font-size: 0.85em; margin-top: 6px; color:#555; text-transform:none; }
</style>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase (compat build - simples para inclusão via <script>) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- LOGIN -->
<div class="container" id="loginContainer">
  <h2>Login</h2>
  <input type="text" id="loginUsuario" placeholder="Usuário ou email" />
  <input type="password" id="loginSenha" placeholder="Senha" />
  <button id="btnEntrar" onclick="fazerLogin()">Entrar</button>
  <div class="small">Use email/senha do Firebase Auth. Fallback <strong>ADMIN / 1234</strong> disponível se Firebase não configurado.</div>
</div>

<!-- MENU PRINCIPAL -->
<div class="container hidden" id="menu">
  <h2>Menu Principal</h2>
  <button onclick="abrirCadastro()">Cadastro</button>
  <button onclick="abrirLancamento()">Lançamento</button>
  <button onclick="sair()">Sair</button>
</div>

<!-- MENU CADASTRO -->
<div class="container hidden" id="menuCadastro">
  <h2>Cadastro</h2>
  <button onclick="abrirInserir()">Inserir</button>
  <button onclick="abrirConsultar()">Consultar</button>
  <button class="btn-voltar" onclick="voltar()">Voltar</button>
</div>

<!-- INSERIR CADASTRO -->
<div class="container hidden" id="inserir">
  <h2>Inserir / Editar Funcionário</h2>
  <input type="hidden" id="idEditando" />
  <input type="text" id="nome" placeholder="Nome" />
  <input type="text" id="cargo" placeholder="Cargo" />
  <button id="btnSalvarCadastro" onclick="salvarCadastro()">Salvar</button>
  <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
</div>

<!-- CONSULTAR CADASTRO -->
<div class="container hidden" id="consultar">
  <h2>Consultar Funcionários</h2>
  <input type="text" id="filtro" placeholder="Filtrar por nome" oninput="mostrarCadastros()" />
  <div class="lista" id="listaCadastros"></div>
  <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
</div>

<!-- MENU LANÇAMENTO -->
<div class="container hidden" id="menuLancamento">
  <h2>Lançamento</h2>
  <button onclick="abrirInserirLancamento()">Inserir</button>
  <button onclick="abrirConsultarLancamento()">Consultar</button>
  <button class="btn-voltar" onclick="voltar()">Voltar</button>
</div>

<!-- INSERIR LANÇAMENTO -->
<div class="container hidden" id="inserirLancamento">
  <h2>Inserir / Editar Lançamento</h2>
  <input type="hidden" id="idLancEditando" />
  <input list="nomesCadastradosLanc" id="nomeLanc" placeholder="Nome do Funcionário" />
  <datalist id="nomesCadastradosLanc"></datalist>
  <input type="date" id="dataLanc" />
  <select id="tipoLanc">
    <option value="">Selecione Tipo</option>
    <option value="VALE">VALE</option>
    <option value="COMPRA">COMPRA</option>
  </select>
  <input type="number" id="valorLanc" placeholder="Valor" step="0.01" />
  <button id="btnSalvarLanc" onclick="salvarLancamento()">Salvar</button>
  <button class="btn-voltar" onclick="voltarLancamento()">Voltar</button>
</div>

<!-- CONSULTAR LANÇAMENTO -->
<div class="container hidden" id="consultarLancamento">
  <h2>Consultar Lançamentos</h2>
  <input type="text" id="filtroLanc" placeholder="Filtrar por nome" oninput="mostrarLancamentos()" />
  <input type="month" id="filtroMesAno" onchange="mostrarLancamentos()" />
  <div class="lista" id="listaLancamentos"></div>
  <button id="btnGerarPDF" onclick="gerarPDFResumoLancamentos()">Gerar PDF</button>
  <button class="btn-voltar" onclick="voltarLancamento()">Voltar</button>
</div>

<script>
/* -------------------------
   FIREBASE CONFIG (fornecido por você)
   ------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDH9MG50ynnt4SiXGAFymBH9nXmBqLwTtU",
  authDomain: "funcionarios-7c778.firebaseapp.com",
  databaseURL: "https://funcionarios-7c778-default-rtdb.firebaseio.com",
  projectId: "funcionarios-7c778",
  storageBucket: "funcionarios-7c778.firebasestorage.app",
  messagingSenderId: "632364021109",
  appId: "1:632364021109:web:fcfaf1de66901c8a8b4f3c",
  measurementId: "G-46DKFS3LHV"
};

let useFirebase = true;
try {
  if (!firebaseConfig || !firebaseConfig.apiKey) throw new Error('No firebase config');
  firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  var db = firebase.firestore();
  // try enable persistence (may fail in some browsers)
  db.enablePersistence && db.enablePersistence().catch(function(err){
    console.warn('Persistence not enabled:', err && err.message);
  });
} catch(err){
  console.warn('Firebase not configured or failed to init. Falling back to localStorage. Error:', err && err.message);
  useFirebase = false;
  var auth = null, db = null;
}

/* -------------------------
   Migração automática localStorage -> Firestore
   - Executa automaticamente apenas se useFirebase === true
   - Marca flag localStorage.migratedToFirestore = 'true' para não repetir
   ------------------------- */
async function migrateLocalToFirestoreIfNeeded(){
  if(!useFirebase) return;
  try {
    // do not migrate if already migrated
    if(localStorage.getItem('migratedToFirestore') === 'true') return;
    // load from localStorage
    const cadastrosLS = JSON.parse(localStorage.getItem('cadastros') || '[]');
    const lancamentosLS = JSON.parse(localStorage.getItem('lancamentos') || '[]');
    // if no data, just mark migrated
    if(cadastrosLS.length === 0 && lancamentosLS.length === 0){
      localStorage.setItem('migratedToFirestore', 'true');
      return;
    }
    // perform migration (attempt): add only if not present in firestore (by exact nome+cargo for cadastros)
    const cadCol = db.collection('cadastros');
    const lancCol = db.collection('lancamentos');

    // fetch existing cadastros names in firestore to reduce duplicates
    const existingCadSnap = await cadCol.get();
    const existingCad = {};
    existingCadSnap.forEach(d => {
      const data = d.data();
      if(data && data.nome) existingCad[data.nome.toString().toUpperCase()] = true;
    });

    // migrate cadastros
    for(const c of cadastrosLS){
      const nomeUp = (c.nome || '').toString().toUpperCase();
      if(!nomeUp) continue;
      if(existingCad[nomeUp]) continue; // skip duplicate
      await cadCol.add({ nome: c.nome.toString(), cargo: c.cargo || '', migratedAt: firebase.firestore.FieldValue.serverTimestamp() });
    }

    // fetch existing lancamentos minimal set to avoid duplicates (we won't be super strict)
    const existingLancSnap = await lancCol.get();
    const existingLanc = new Set();
    existingLancSnap.forEach(d => {
      const data = d.data();
      if(data && data.nome && data.data && data.tipo && (typeof data.valor !== 'undefined')){
        existingLanc.add(`${data.nome}||${data.data}||${data.tipo}||${data.valor}`);
      }
    });

    // migrate lancamentos
    for(const l of lancamentosLS){
      const key = `${l.nome}||${l.data}||${l.tipo}||${l.valor}`;
      if(existingLanc.has(key)) continue; // skip exact duplicate
      // ensure date stored as YYYY-MM-DD (keeps same format)
      await lancCol.add({ nome: l.nome, data: l.data, tipo: l.tipo, valor: parseFloat(l.valor || 0), migratedAt: firebase.firestore.FieldValue.serverTimestamp() });
    }

    // mark migrated locally to avoid repeating
    localStorage.setItem('migratedToFirestore', 'true');
    console.log('Migração localStorage → Firestore concluída.');
  } catch(err){
    console.warn('Erro na migração automática:', err && err.message);
  }
}

/* -------------------------
   Foco inicial no Usuário e SW reg
   ------------------------- */
window.addEventListener('load', () => {
  const u = document.getElementById('loginUsuario');
  if (u) { u.focus(); u.select && u.select(); }
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(() => {
      console.log('Service Worker registrado.');
    }).catch(e => console.warn('SW registration failed:', e));
  }
  // start migration if firebase active
  migrateLocalToFirestoreIfNeeded();
});

/* -------------------------
   Enter: navegação e executar último botão
   ------------------------- */
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Enter') return;
  const interactive = Array.from(document.querySelectorAll('input, select, button'))
    .filter(el => el.offsetParent !== null && !el.disabled && el.type !== 'hidden');
  const target = e.target;
  const idx = interactive.indexOf(target);
  if (idx === -1) return;
  e.preventDefault();
  const nextIndex = idx + 1;
  if (nextIndex < interactive.length) {
    const next = interactive[nextIndex];
    next.focus();
  } else {
    const el = interactive[idx];
    if (el && typeof el.click === 'function') el.click();
  }
});

/* -------------------------
   Maiúsculas automáticas
   ------------------------- */
document.addEventListener('input', function(e) {
  const el = e.target; if (!el) return;
  const tag = el.tagName.toLowerCase();
  if (tag === 'input') {
    const t = el.type;
    if (t === 'text' || t === 'search' || t === 'tel' || t === 'email') {
      const pos = el.selectionStart;
      el.value = el.value.toUpperCase();
      try { el.setSelectionRange(pos, pos); } catch(err){}
    }
  } else if (tag === 'textarea') {
    const pos = el.selectionStart;
    el.value = el.value.toUpperCase();
    try { el.setSelectionRange(pos, pos); } catch(err){}
  }
});

/* -------------------------
   Navegação entre telas
   ------------------------- */
function esconderTudo(){ document.querySelectorAll('.container').forEach(div=>div.classList.add('hidden')); }
function abrirCadastro(){ esconderTudo(); document.getElementById('menuCadastro').classList.remove('hidden'); }
function abrirLancamento(){ esconderTudo(); document.getElementById('menuLancamento').classList.remove('hidden'); }
function voltar(){ esconderTudo(); document.getElementById('menu').classList.remove('hidden'); }
function voltarCadastro(){ esconderTudo(); document.getElementById('menuCadastro').classList.remove('hidden'); }
function voltarLancamento(){ esconderTudo(); document.getElementById('menuLancamento').classList.remove('hidden'); }
function sair(){ if(useFirebase){ firebase.auth().signOut(); } alert('Saindo do sistema...'); location.reload(); }

/* -------------------------
   LOGIN
   - Uses Firebase Auth (email/password)
   - Fallback to local ADMIN/1234 if Firebase not configured
   ------------------------- */
function fazerLogin(){
  const usuario = (document.getElementById('loginUsuario').value || '').trim();
  const senha = (document.getElementById('loginSenha').value || '').trim();
  if(useFirebase){
    // If user typed ADMIN with password 1234, allow local fallback even when Firebase enabled.
    if(usuario.toUpperCase() === 'ADMIN' && senha === '1234'){
      document.getElementById('loginContainer').classList.add('hidden');
      document.getElementById('menu').classList.remove('hidden');
      alert('Login bem-sucedido (fallback local)!');
      const btn = document.querySelector('#menu button'); if (btn) btn.focus();
      return;
    }
    // assume they provide full email; if they typed a short name without '@', require full email
    const email = usuario.includes('@') ? usuario : usuario;
    firebase.auth().signInWithEmailAndPassword(email, senha)
      .then(() => {
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('menu').classList.remove('hidden');
        alert('Login bem-sucedido!');
        const btn = document.querySelector('#menu button'); if (btn) btn.focus();
      })
      .catch(err => {
        alert('Erro no login: ' + (err && err.message ? err.message : err));
        const u = document.getElementById('loginUsuario'); if(u){ u.focus(); u.select && u.select(); }
      });
  } else {
    // local fallback
    if (usuario.toUpperCase() === 'ADMIN' && senha === '1234') {
      document.getElementById('loginContainer').classList.add('hidden');
      document.getElementById('menu').classList.remove('hidden');
      alert('Login bem-sucedido (local)!');
      const btn = document.querySelector('#menu button'); if (btn) btn.focus();
    } else {
      alert('Usuário ou senha incorretos!');
      const u = document.getElementById('loginUsuario'); if(u){ u.focus(); u.select && u.select(); }
    }
  }
}

/* -------------------------
   CADASTROS (Firestore or localStorage)
   ------------------------- */
const nomeInput = document.getElementById('nome');
const cargoInput = document.getElementById('cargo');
const idEditandoInput = document.getElementById('idEditando');

async function abrirInserir(){ esconderTudo(); document.getElementById('inserir').classList.remove('hidden'); limparCamposCadastro(); }
function abrirConsultar(){ esconderTudo(); document.getElementById('consultar').classList.remove('hidden'); mostrarCadastros(); }

async function salvarCadastro(){
  const nome = (nomeInput.value || '').trim();
  const cargo = (cargoInput.value || '').trim();
  if(!nome || !cargo) return alert('Preencha todos os campos.');
  if(useFirebase){
    const idEditando = idEditandoInput.value;
    try {
      if(idEditando){
        await db.collection('cadastros').doc(idEditando).set({ nome, cargo, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      } else {
        await db.collection('cadastros').add({ nome, cargo, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
      limparCamposCadastro();
      voltarCadastro();
    } catch(err){ alert('Erro ao salvar no Firebase: ' + (err && err.message)); }
  } else {
    let cadastros = JSON.parse(localStorage.getItem('cadastros'))||[];
    const idEditando = idEditandoInput.value;
    if(idEditando){
      const idx = cadastros.findIndex(c => c.id == idEditando);
      if(idx > -1){ cadastros[idx].nome = nome; cadastros[idx].cargo = cargo; }
    } else {
      const novoId = cadastros.length ? (cadastros[cadastros.length-1].id + 1) : 1;
      cadastros.push({ id: novoId, nome, cargo });
    }
    localStorage.setItem('cadastros', JSON.stringify(cadastros));
    limparCamposCadastro();
    voltarCadastro();
  }
}

async function mostrarCadastros(){
  const lista = document.getElementById('listaCadastros');
  const filtro = (document.getElementById('filtro').value || '').trim().toUpperCase();
  lista.innerHTML = '';
  if(useFirebase){
    try {
      const snapshot = await db.collection('cadastros').orderBy('nome').get();
      snapshot.forEach(doc => {
        const c = Object.assign({ id: doc.id }, doc.data());
        if(filtro && !(c.nome||'').toUpperCase().includes(filtro)) return;
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<span ondblclick="editarCadastro('${c.id}')"><strong>${c.nome}</strong> - ${c.cargo}</span>
          <button class="btn-excluir" onclick="excluirCadastro('${c.id}')" title="Excluir">🗑️</button>`;
        lista.appendChild(div);
      });
    } catch(err){ console.warn('Erro listando cadastros:', err); }
  } else {
    let cadastros = JSON.parse(localStorage.getItem('cadastros'))||[];
    if(filtro) cadastros = cadastros.filter(c => (c.nome||'').toUpperCase().includes(filtro));
    cadastros.forEach(c => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span ondblclick="editarCadastro(${c.id})"><strong>${c.nome}</strong> - ${c.cargo}</span>
        <button class="btn-excluir" onclick="excluirCadastro(${c.id})" title="Excluir">🗑️</button>`;
      lista.appendChild(div);
    });
  }
}

async function editarCadastro(id){
  if(useFirebase){
    try {
      const doc = await db.collection('cadastros').doc(id).get();
      if(!doc.exists) return;
      const c = Object.assign({ id: doc.id }, doc.data());
      esconderTudo(); document.getElementById('inserir').classList.remove('hidden');
      idEditandoInput.value = c.id; nomeInput.value = c.nome; cargoInput.value = c.cargo;
    } catch(err){ console.warn(err); }
  } else {
    const cadastros = JSON.parse(localStorage.getItem('cadastros'))||[];
    const c = cadastros.find(x => x.id === id);
    if(!c) return;
    esconderTudo(); document.getElementById('inserir').classList.remove('hidden');
    idEditandoInput.value = c.id; nomeInput.value = c.nome; cargoInput.value = c.cargo;
  }
}

async function excluirCadastro(id){
  if(!confirm('Excluir este cadastro?')) return;
  if(useFirebase){
    try {
      await db.collection('cadastros').doc(id).delete();
      mostrarCadastros();
    } catch(err){ alert('Erro ao excluir: ' + (err && err.message)); }
  } else {
    let cadastros = JSON.parse(localStorage.getItem('cadastros'))||[];
    cadastros = cadastros.filter(c => c.id !== id);
    localStorage.setItem('cadastros', JSON.stringify(cadastros));
    mostrarCadastros();
  }
}

function limparCamposCadastro(){ idEditandoInput.value=''; nomeInput.value=''; cargoInput.value=''; }

/* -------------------------
   LANÇAMENTOS (Firestore or localStorage)
   ------------------------- */
const nomeLanc = document.getElementById('nomeLanc');
const dataLanc = document.getElementById('dataLanc');
const tipoLanc = document.getElementById('tipoLanc');
const valorLanc = document.getElementById('valorLanc');
const idLancEditando = document.getElementById('idLancEditando');

async function abrirInserirLancamento(){
  if(useFirebase){
    const snap = await db.collection('cadastros').limit(1).get();
    if(snap.empty){ alert('Nenhum funcionário cadastrado. Cadastre antes de lançar.'); abrirCadastro(); return; }
  } else {
    const cadastros = JSON.parse(localStorage.getItem('cadastros'))||[];
    if(cadastros.length === 0){ alert('Nenhum funcionário cadastrado. Cadastre antes de lançar.'); abrirCadastro(); return; }
  }
  esconderTudo(); document.getElementById('inserirLancamento').classList.remove('hidden');
  limparCamposLancamento();
  atualizarDatalistLanc();
}

function abrirConsultarLancamento(){ esconderTudo(); document.getElementById('consultarLancamento').classList.remove('hidden'); mostrarLancamentos(); }

async function salvarLancamento(){
  const nome = (nomeLanc.value || '').trim().toUpperCase();
  const data = dataLanc.value;
  const tipo = tipoLanc.value;
  const valor = parseFloat(valorLanc.value);
  if(!nome || !data || !tipo || isNaN(valor)) return alert('Preencha todos os campos corretamente.');
  if(useFirebase){
    // verify name exists
    const snap = await db.collection('cadastros').where('nome', '==', nome).limit(1).get();
    if(snap.empty) return alert('Nome não cadastrado. Cadastre antes de lançar.');
    try {
      const idEdit = idLancEditando.value;
      if(idEdit){
        await db.collection('lancamentos').doc(idEdit).set({ nome, data, tipo, valor, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      } else {
        await db.collection('lancamentos').add({ nome, data, tipo, valor, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
      limparCamposLancamento();
      voltarLancamento();
    } catch(err){ alert('Erro ao salvar lançamento: ' + (err && err.message)); }
  } else {
    let lancamentos = JSON.parse(localStorage.getItem('lancamentos'))||[];
    const idEdit = idLancEditando.value;
    if(idEdit){
      const idx = lancamentos.findIndex(l => l.id == idEdit);
      if(idx > -1){ lancamentos[idx] = { id: lancamentos[idx].id, nome, data, tipo, valor }; }
    } else {
      const novoId = lancamentos.length ? (lancamentos[lancamentos.length-1].id + 1) : 1;
      lancamentos.push({ id: novoId, nome, data, tipo, valor });
    }
    localStorage.setItem('lancamentos', JSON.stringify(lancamentos));
    limparCamposLancamento();
    voltarLancamento();
  }
}

async function mostrarLancamentos(){
  const lista = document.getElementById('listaLancamentos');
  const filtroNome = (document.getElementById('filtroLanc').value || '').trim().toUpperCase();
  const filtroMesAno = document.getElementById('filtroMesAno').value;
  lista.innerHTML = '';
  if(useFirebase){
    let query = db.collection('lancamentos').orderBy('data', 'desc').limit(500);
    try {
      const snap = await query.get();
      snap.forEach(doc => {
        const l = Object.assign({ id: doc.id }, doc.data());
        if(filtroNome && !(l.nome||'').toUpperCase().includes(filtroNome)) return;
        if(filtroMesAno && !(l.data||'').startsWith(filtroMesAno)) return;
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<span ondblclick="editarLancamento('${l.id}')"><strong>${l.id} - ${l.nome}</strong> | ${l.data} | ${l.tipo} | R$ ${parseFloat(l.valor).toFixed(2).replace('.', ',')}</span>
          <button class="btn-excluir" onclick="excluirLancamento('${l.id}')">🗑️</button>`;
        lista.appendChild(div);
      });
    } catch(err){ console.warn('Erro listando lançamentos:', err); }
  } else {
    let lancamentos = JSON.parse(localStorage.getItem('lancamentos'))||[];
    if(filtroNome) lancamentos = lancamentos.filter(l => (l.nome||'').toUpperCase().includes(filtroNome));
    if(filtroMesAno) lancamentos = lancamentos.filter(l => (l.data||'').startsWith(filtroMesAno));
    lancamentos.forEach(l => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span ondblclick="editarLancamento(${l.id})"><strong>${l.id} - ${l.nome}</strong> | ${l.data} | ${l.tipo} | R$ ${l.valor.toFixed(2).replace('.', ',')}</span>
        <button class="btn-excluir" onclick="excluirLancamento(${l.id})">🗑️</button>`;
      lista.appendChild(div);
    });
  }
}

async function editarLancamento(id){
  if(useFirebase){
    const doc = await db.collection('lancamentos').doc(id).get();
    if(!doc.exists) return;
    const l = Object.assign({ id: doc.id }, doc.data());
    esconderTudo(); document.getElementById('inserirLancamento').classList.remove('hidden');
    idLancEditando.value = l.id; nomeLanc.value = l.nome; dataLanc.value = l.data; tipoLanc.value = l.tipo; valorLanc.value = l.valor;
  } else {
    const lancamentos = JSON.parse(localStorage.getItem('lancamentos'))||[];
    const l = lancamentos.find(x => x.id === id);
    if(!l) return;
    esconderTudo(); document.getElementById('inserirLancamento').classList.remove('hidden');
    idLancEditando.value = l.id; nomeLanc.value = l.nome; dataLanc.value = l.data; tipoLanc.value = l.tipo; valorLanc.value = l.valor;
  }
}

async function excluirLancamento(id){
  if(!confirm('Excluir este lançamento?')) return;
  if(useFirebase){
    try {
      await db.collection('lancamentos').doc(id).delete();
      mostrarLancamentos();
    } catch(err){ alert('Erro ao excluir: ' + (err && err.message)); }
  } else {
    let lancamentos = JSON.parse(localStorage.getItem('lancamentos'))||[];
    lancamentos = lancamentos.filter(l => l.id !== id);
    localStorage.setItem('lancamentos', JSON.stringify(lancamentos));
    mostrarLancamentos();
  }
}

function limparCamposLancamento(){
  idLancEditando.value=''; nomeLanc.value=''; dataLanc.value=''; tipoLanc.value=''; valorLanc.value='';
}

async function atualizarDatalistLanc(){
  const datalist = document.getElementById('nomesCadastradosLanc'); datalist.innerHTML = '';
  if(useFirebase){
    const snap = await db.collection('cadastros').orderBy('nome').get();
    snap.forEach(doc => {
      const c = Object.assign({ id: doc.id }, doc.data());
      const opt = document.createElement('option'); opt.value = c.nome; datalist.appendChild(opt);
    });
  } else {
    const cadastros = JSON.parse(localStorage.getItem('cadastros'))||[];
    cadastros.forEach(c => { const opt = document.createElement('option'); opt.value = c.nome; datalist.appendChild(opt); });
  }
}

/* -------------------------
   GERAR PDF - usa dados atuais filtrados do Firestore ou localStorage
   ------------------------- */
async function gerarPDFResumoLancamentos(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const pageWidth = pdf.internal.pageSize.getWidth();

  pdf.setFontSize(14);
  pdf.setFont("helvetica", "bold");
  const titulo = "SUPERMERCADO LEV +";
  const tituloWidth = pdf.getTextWidth(titulo);
  pdf.text(titulo, (pageWidth - tituloWidth) / 2, 15);

  const agora = new Date();
  const dataHoraStr = agora.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
  pdf.setFontSize(10);
  pdf.setFont("helvetica", "normal");
  pdf.text(dataHoraStr, 10, 22);

  const filtroMesAno = document.getElementById('filtroMesAno').value;
  if (filtroMesAno) {
    const [ano, mes] = filtroMesAno.split('-');
    const periodoStr = `Período: ${mes}/${ano}`;
    const periodoWidth = pdf.getTextWidth(periodoStr);
    pdf.text(periodoStr, (pageWidth - periodoWidth) / 2, 22);
  }
  pdf.line(10, 25, pageWidth - 10, 25);

  let y = 35;
  pdf.setFontSize(12);
  pdf.setFont("helvetica", "bold");
  pdf.text("RESUMO DE LANÇAMENTOS", 10, y);
  y += 10;

  let lancamentos = [];
  if(useFirebase){
    const snap = await db.collection('lancamentos').get();
    snap.forEach(doc => lancamentos.push(Object.assign({ id: doc.id }, doc.data())));
    if(filtroMesAno) lancamentos = lancamentos.filter(l => l.data && l.data.startsWith(filtroMesAno));
  } else {
    lancamentos = JSON.parse(localStorage.getItem('lancamentos')) || [];
    if (filtroMesAno) lancamentos = lancamentos.filter(l => l.data && l.data.startsWith(filtroMesAno));
  }

  const resumo = {};
  lancamentos.forEach(l => { const nomeUp = (l.nome || '').toUpperCase(); resumo[nomeUp] = (resumo[nomeUp] || 0) + parseFloat(l.valor || 0); });

  pdf.setFont("helvetica", "normal");
  const nomesOrdenados = Object.keys(resumo).sort();

  nomesOrdenados.forEach(nome => {
    const valorFormatado = "R$ " + resumo[nome].toFixed(2).replace('.', ',');
    const leftX = 10;
    const rightX = pageWidth - 10;
    const nomeWidth = pdf.getTextWidth(nome);
    const valorWidth = pdf.getTextWidth(valorFormatado);
    const totalDotsWidth = rightX - leftX - nomeWidth - valorWidth - 8;
    const dotWidth = pdf.getTextWidth('.');
    const dotsCount = Math.floor(totalDotsWidth / dotWidth);
    const dots = '.'.repeat(dotsCount > 0 ? dotsCount : 3);

    const linha = `${nome} ${dots} ${valorFormatado}`;
    pdf.text(linha, leftX, y);
    y += 8;
    if (y > 280) { pdf.addPage(); y = 20; }
  });

  const totalGeral = Object.values(resumo).reduce((a,b) => a + b, 0);
  const totalNome = "TOTAL GERAL";
  const totalValor = "R$ " + totalGeral.toFixed(2).replace('.', ',');
  const leftX = 10;
  const rightX = pageWidth - 10;
  const nomeWidth = pdf.getTextWidth(totalNome);
  const valorWidth = pdf.getTextWidth(totalValor);
  const totalDotsWidth = rightX - leftX - nomeWidth - valorWidth - 8;
  const dotWidth = pdf.getTextWidth('.');
  const dotsCount = Math.floor(totalDotsWidth / dotWidth);
  const dots = '.'.repeat(dotsCount > 0 ? dotsCount : 3);

  y += 10;
  pdf.setFont("helvetica", "bold");
  pdf.text(`${totalNome} ${dots} ${totalValor}`, leftX, y);

  pdf.save("RESUMO_LANCAMENTOS_SUPERMERCADO_LEV+.pdf");
}
</script>

</body>
</html>
