<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Simples - Funcionários</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0; padding: 10px;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
      text-transform: uppercase;
      box-sizing: border-box;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      text-align: center;
      width: 100%;
      max-width: 380px;
      box-sizing: border-box;
    }
    h2 { margin-bottom: 20px; font-size: 1.4em; }
    input, select, textarea {
      width: 100%; padding: 10px; margin: 5px 0;
      border-radius: 6px; border: 1px solid #ccc;
      font-size: 16px; box-sizing: border-box;
      text-transform: uppercase;
    }
    button {
      width: 100%; padding: 12px; margin: 8px 0;
      border: none; border-radius: 8px;
      background-color: #007bff; color: white; font-size: 16px;
      cursor: pointer; transition: background 0.2s;
    }
    button:hover { background-color: #0056b3; }
    .btn-voltar { background-color: #6c757d; }
    .btn-voltar:hover { background-color: #565e64; }
    .hidden { display: none; }
    .lista {
      text-align: left; margin-top: 10px;
      max-height: 250px; overflow-y: auto;
    }
    .item {
      display: flex; justify-content: space-between; align-items: center;
      background: #f1f3f5; padding: 6px 8px; border-radius: 6px;
      margin: 4px 0;
    }
    .btn-excluir {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      background-color: #dc3545; color: white;
      border: none; border-radius: 50%;
      cursor: pointer; font-size: 14px;
    }
    .btn-excluir:hover {
      background-color: #b02a37;
    }
    @media (max-width: 400px) {
      h2 { font-size: 1.2em; }
      button { font-size: 15px; padding: 10px; }
      input, select, textarea { font-size: 15px; padding: 8px; }
    }
  </style>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase App & Database -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>

</head>
<body>

  <!-- LOGIN -->
  <div class="container" id="loginContainer">
    <h2>Login</h2>
    <input type="text" id="loginUsuario" placeholder="Usuário" />
    <input type="password" id="loginSenha" placeholder="Senha" />
    <button onclick="fazerLogin()">Entrar</button>
  </div>

  <!-- MENU PRINCIPAL -->
  <div class="container hidden" id="menu">
    <h2>Menu Principal</h2>
    <button onclick="abrirCadastro()">Cadastro</button>
    <button onclick="abrirLancamento()">Lançamento</button>
    <button onclick="sair()">Sair</button>
  </div>

  <!-- MENU CADASTRO -->
  <div class="container hidden" id="menuCadastro">
    <h2>Cadastro</h2>
    <button onclick="abrirInserir()">Inserir</button>
    <button onclick="abrirConsultar()">Consultar</button>
    <button class="btn-voltar" onclick="voltar()">Voltar</button>
  </div>

  <!-- INSERIR / EDITAR CADASTRO -->
  <div class="container hidden" id="inserir">
    <h2>Inserir / Editar Funcionário</h2>
    <input type="hidden" id="idEditando" />
    <input type="text" id="nome" placeholder="Nome" />
    <input type="text" id="cargo" placeholder="Cargo" />
    <button onclick="salvarCadastro()">Salvar</button>
    <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
  </div>

  <!-- CONSULTAR CADASTRO -->
  <div class="container hidden" id="consultar">
    <h2>Consultar Funcionários</h2>
    <input type="text" id="filtro" placeholder="Filtrar por nome" oninput="mostrarCadastros()" />
    <div class="lista" id="listaCadastros"></div>
    <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
  </div>

  <!-- MENU LANÇAMENTO -->
  <div class="container hidden" id="menuLancamento">
    <h2>Lançamento</h2>
    <button onclick="abrirInserirLancamento()">Inserir</button>
    <button onclick="abrirConsultarLancamento()">Consultar</button>
    <button class="btn-voltar" onclick="voltar()">Voltar</button>
  </div>

  <!-- INSERIR / EDITAR LANÇAMENTO -->
  <div class="container hidden" id="inserirLancamento">
    <h2>Inserir / Editar Lançamento</h2>
    <input type="hidden" id="idLancEditando" />
    <input list="nomesCadastradosLanc" id="nomeLanc" placeholder="Nome do Funcionário" />
    <datalist id="nomesCadastradosLanc"></datalist>
    <input type="date" id="dataLanc" />
    <select id="tipoLanc">
      <option value="">Selecione Tipo</option>
      <option value="VALE">VALE</option>
      <option value="COMPRA">COMPRA</option>
    </select>
    <input type="number" id="valorLanc" placeholder="Valor" step="0.01" />
    <button onclick="salvarLancamento()">Salvar</button>
    <button class="btn-voltar" onclick="voltarLancamento()">Voltar</button>
  </div>

  <!-- CONSULTAR LANÇAMENTO -->
  <div class="container hidden" id="consultarLancamento">
    <h2>Consultar Lançamentos</h2>
    <input type="text" id="filtroLanc" placeholder="Filtrar por nome" oninput="mostrarLancamentos()" />
    <input type="month" id="filtroMesAno" onchange="mostrarLancamentos()" />
    <div class="lista" id="listaLancamentos"></div>
    <button onclick="gerarPDFResumoLancamentos()">Gerar PDF</button>
    <button class="btn-voltar" onclick="voltarLancamento()">Voltar</button>
  </div>

<script>
  // ============= Inicialização do Firebase =============
  const firebaseConfig = {
    apiKey: "AIzaSyDH9MG50ynnt4SiXGAFymBH9nXmBqLwTtU",
    authDomain: "funcionarios-7c778.firebaseapp.com",
    databaseURL: "https://funcionarios-7c778-default-rtdb.firebaseio.com/",
    projectId: "funcionarios-7c778",
    storageBucket: "funcionarios-7c778.firebasestorage.app",
    messagingSenderId: "632364021109",
    appId: "1:632364021109:web:fcfaf1de66901c8a8b4f3c"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ============= Seleção de elementos =============
  const loginContainer = document.getElementById('loginContainer');
  const menu = document.getElementById('menu');
  const menuCadastro = document.getElementById('menuCadastro');
  const menuLancamento = document.getElementById('menuLancamento');
  const inserir = document.getElementById('inserir');
  const consultar = document.getElementById('consultar');
  const inserirLancamento = document.getElementById('inserirLancamento');
  const consultarLancamento = document.getElementById('consultarLancamento');

  const loginUsuario = document.getElementById('loginUsuario');
  const loginSenha = document.getElementById('loginSenha');

  const idEditando = document.getElementById('idEditando');
  const nomeInput = document.getElementById('nome');
  const cargoInput = document.getElementById('cargo');

  const filtro = document.getElementById('filtro');
  const listaCadastros = document.getElementById('listaCadastros');

  const idLancEditando = document.getElementById('idLancEditando');
  const nomeLanc = document.getElementById('nomeLanc');
  const dataLanc = document.getElementById('dataLanc');
  const tipoLanc = document.getElementById('tipoLanc');
  const valorLanc = document.getElementById('valorLanc');

  const filtroLanc = document.getElementById('filtroLanc');
  const filtroMesAno = document.getElementById('filtroMesAno');
  const listaLancamentos = document.getElementById('listaLancamentos');

  // ============= Navegação entre telas =============
  function esconderTudo() {
    document.querySelectorAll('.container').forEach(div => div.classList.add('hidden'));
  }
  function abrirCadastro(){ esconderTudo(); menuCadastro.classList.remove('hidden'); }
  function abrirLancamento(){ esconderTudo(); menuLancamento.classList.remove('hidden'); }
  function voltar(){ esconderTudo(); menu.classList.remove('hidden'); }
  function voltarCadastro(){ esconderTudo(); menuCadastro.classList.remove('hidden'); }
  function voltarLancamento(){ esconderTudo(); menuLancamento.classList.remove('hidden'); }
  function sair(){ location.reload(); }

  // ============= Login simples =============
  function fazerLogin(){
    const u = (loginUsuario.value||'').trim().toUpperCase();
    const s = (loginSenha.value||'').trim();
    if(u === 'ADMIN' && s === '1234'){
      loginContainer.classList.add('hidden');
      menu.classList.remove('hidden');
      alert('Login bem-sucedido!');
    } else {
      alert('Usuário ou senha incorretos!');
      loginUsuario.focus();
    }
  }

  // ============= CADASTRO =============
  function abrirInserir(){
    esconderTudo();
    inserir.classList.remove('hidden');
    limparCamposCadastro();
  }
  function abrirConsultar(){
    esconderTudo();
    consultar.classList.remove('hidden');
    mostrarCadastros();
  }

  async function salvarCadastro(){
    const nome = (nomeInput.value||'').trim();
    const cargo = (cargoInput.value||'').trim();
    if(!nome || !cargo){
      return alert('Preencha todos os campos.');
    }
    const dbRef = db.ref('cadastros');
    const id = idEditando.value || dbRef.push().key;
    await db.ref('cadastros/' + id).set({ nome, cargo });
    limparCamposCadastro();
    voltarCadastro();
  }

  function mostrarCadastros(){
    const filtroTexto = (filtro.value||'').trim().toUpperCase();
    const refCad = db.ref('cadastros');
    refCad.off(); // remove listeners anteriores
    refCad.on('value', snapshot => {
      listaCadastros.innerHTML = '';
      const dados = snapshot.val() || {};
      Object.entries(dados).forEach(([id, c]) => {
        if(!filtroTexto || (c.nome || '').toUpperCase().includes(filtroTexto)){
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `<span ondblclick="editarCadastro('${id}')">
            <strong>${c.nome}</strong> - ${c.cargo}
          </span>
          <button class="btn-excluir" onclick="excluirCadastro('${id}')">🗑️</button>`;
          listaCadastros.appendChild(div);
        }
      });
    });
  }

  async function excluirCadastro(id){
    if(!confirm('Excluir este cadastro?')) return;
    await db.ref('cadastros/' + id).remove();
  }

  async function editarCadastro(id){
    const snap = await db.ref('cadastros/' + id).get();
    if(snap.exists()){
      const c = snap.val();
      esconderTudo();
      inserir.classList.remove('hidden');
      idEditando.value = id;
      nomeInput.value = c.nome;
      cargoInput.value = c.cargo;
    }
  }

  function limparCamposCadastro(){
    idEditando.value = '';
    nomeInput.value = '';
    cargoInput.value = '';
  }

  // ============= LANÇAMENTOS =============
  function abrirInserirLancamento(){
    // verifica se existe funcionário cadastrado
    db.ref('cadastros').get().then(snap=>{
      const dados = snap.val() || {};
      if(Object.keys(dados).length === 0){
        alert('Nenhum funcionário cadastrado. Cadastre antes.');
        abrirCadastro();
      } else {
        esconderTudo();
        inserirLancamento.classList.remove('hidden');
        limparCamposLancamento();
        atualizarDatalistLanc();
      }
    });
  }

  function abrirConsultarLancamento(){
    esconderTudo();
    consultarLancamento.classList.remove('hidden');
    mostrarLancamentos();
  }

  async function salvarLancamento(){
    const nome = (nomeLanc.value||'').trim().toUpperCase();
    const data = dataLanc.value;
    const tipo = tipoLanc.value;
    const valor = parseFloat(valorLanc.value);
    if(!nome || !data || !tipo || isNaN(valor)){
      return alert('Preencha todos os campos corretamente.');
    }
    // verifica se funcionário existe
    const snap = await db.ref('cadastros').orderByChild('nome').equalTo(nome).get();
    if(!snap.exists()){
      return alert('Nome não cadastrado. Cadastre antes.');
    }

    const refLanc = db.ref('lancamentos');
    const id = idLancEditando.value || refLanc.push().key;
    await db.ref('lancamentos/' + id).set({ nome, data, tipo, valor });
    limparCamposLancamento();
    voltarLancamento();
  }

  function mostrarLancamentos(){
    const filtroNomeTexto = (filtroLanc.value||'').trim().toUpperCase();
    const mesAno = filtroMesAno.value;
    const refLan = db.ref('lancamentos');
    refLan.off();
    refLan.on('value', snapshot => {
      listaLancamentos.innerHTML = '';
      const dados = snapshot.val() || {};
      Object.entries(dados).forEach(([id, l]) => {
        const okNome = !filtroNomeTexto || (l.nome || '').toUpperCase().includes(filtroNomeTexto);
        const okMes = !mesAno || l.data.startsWith(mesAno);
        if(okNome && okMes){
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `<span ondblclick="editarLancamento('${id}')">
            <strong>${l.nome}</strong> | ${l.data} | ${l.tipo} | R$ ${l.valor.toFixed(2).replace('.', ',')}
          </span>
          <button class="btn-excluir" onclick="excluirLancamento('${id}')">🗑️</button>`;
          listaLancamentos.appendChild(div);
        }
      });
    });
  }

  async function excluirLancamento(id){
    if(!confirm('Excluir este lançamento?')) return;
    await db.ref('lancamentos/' + id).remove();
  }

  async function editarLancamento(id){
    const snap = await db.ref('lancamentos/' + id).get();
    if(snap.exists()){
      const l = snap.val();
      esconderTudo();
      inserirLancamento.classList.remove('hidden');
      idLancEditando.value = id;
      nomeLanc.value = l.nome;
      dataLanc.value = l.data;
      tipoLanc.value = l.tipo;
      valorLanc.value = l.valor;
    }
  }

  function limparCamposLancamento(){
    idLancEditando.value = '';
    nomeLanc.value = '';
    dataLanc.value = '';
    tipoLanc.value = '';
    valorLanc.value = '';
  }

  function atualizarDatalistLanc(){
    db.ref('cadastros').get().then(snap => {
      const dados = snap.val() || {};
      const dl = nomesCadastradosLanc;
      dl.innerHTML = '';
      Object.values(dados).forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.nome;
        dl.appendChild(opt);
      });
    });
  }

  // ============= PDF de resumo =============
  async function gerarPDFResumoLancamentos(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    const snapshot = await db.ref('lancamentos').get();
    const dados = snapshot.val() || {};
    const mesAno = filtroMesAno.value;
    const lancs = Object.values(dados).filter(l => {
      return !mesAno || l.data.startsWith(mesAno);
    });

    const resumo = {};
    lancs.forEach(l => {
      if(!resumo[l.nome]) resumo[l.nome] = 0;
      resumo[l.nome] += l.valor;
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    pdf.setFontSize(14);
    pdf.setFont("helvetica", "bold");
    const titulo = "SUPERMERCADO LEV +";
    const tituloWidth = pdf.getTextWidth(titulo);
    pdf.text(titulo, (pageWidth - tituloWidth)/2, 15);

    const agora = new Date();
    const dataHoraStr = agora.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
    pdf.setFontSize(10);
    pdf.setFont("helvetica", "normal");
    pdf.text(dataHoraStr, 10, 22);

    if(mesAno){
      const [ano, mes] = mesAno.split('-');
      const periodoStr = `Período: ${mes}/${ano}`;
      const periodoWidth = pdf.getTextWidth(periodoStr);
      pdf.text(periodoStr, (pageWidth - periodoWidth)/2, 22);
    }

    pdf.line(10, 25, pageWidth - 10, 25);
    let y = 35;
    pdf.setFontSize(12);
    pdf.setFont("helvetica", "bold");
    pdf.text("RESUMO DE LANÇAMENTOS", 10, y);
    y += 10;

    pdf.setFont("helvetica", "normal");
    const nomes = Object.keys(resumo).sort();
    nomes.forEach(nome => {
      const valorFmt = "R$ " + resumo[nome].toFixed(2).replace('.', ',');
      const leftX = 10;
      const rightX = pageWidth - 10;
      const nomeW = pdf.getTextWidth(nome);
      const valorW = pdf.getTextWidth(valorFmt);
      const totalDotsW = rightX - leftX - nomeW - valorW - 8;
      const dotW = pdf.getTextWidth('.');
      const dotsCount = Math.floor(totalDotsW / dotW);
      const dots = '.'.repeat(dotsCount > 0 ? dotsCount : 3);
      const linha = `${nome} ${dots} ${valorFmt}`;
      pdf.text(linha, leftX, y);
      y += 8;
      if (y > 280) {
        pdf.addPage();
        y = 20;
      }
    });

    // total geral
    const totalGeral = Object.values(resumo).reduce((a,b) => a + b, 0);
    const totalNome = "TOTAL GERAL";
    const totalValor = "R$ " + totalGeral.toFixed(2).replace('.', ',');
    const leftX = 10;
    const rightX = pageWidth - 10;
    const nomeW = pdf.getTextWidth(totalNome);
    const valorW = pdf.getTextWidth(totalValor);
    const totalDotsW = rightX - leftX - nomeW - valorW - 8;
    const dotW = pdf.getTextWidth('.');
    const dotsCount = Math.floor(totalDotsW / dotW);
    const dots = '.'.repeat(dotsCount > 0 ? dotsCount : 3);
    y += 10;
    pdf.setFont("helvetica", "bold");
    pdf.text(`${totalNome} ${dots} ${totalValor}`, leftX, y);

    pdf.save("RESUMO_LANCAMENTOS_SUPERMERCADO_LEV+.pdf");
  }

  // ================== INICIALIZAÇÃO ====================
  window.onload = () => {
    loginUsuario.focus();
  };
</script>

</body>
</html>
