<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema Funcion√°rios ‚Äî Cadastro, Lan√ßamentos e PDF</title>
<style>
  body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:10px; min-height:100vh;
         display:flex; align-items:center; justify-content:center; text-transform:uppercase; box-sizing:border-box; }
  .container { background:#fff; padding:22px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.18);
               width:100%; max-width:420px; box-sizing:border-box; text-align:center; }
  h2{ margin:0 0 16px 0; font-size:1.3rem; }
  input, select { width:100%; padding:10px; margin:6px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:15px; text-transform:uppercase; }
  button { width:100%; padding:12px; margin:8px 0; border:none; border-radius:8px; background:#007bff; color:#fff; font-size:15px; cursor:pointer; }
  button:hover{ background:#0056b3; }
  .btn-voltar{ background:#6c757d; } .btn-voltar:hover{ background:#565e64; }
  .hidden{ display:none; }
  .lista{ text-align:left; margin-top:10px; max-height:280px; overflow:auto; }
  .item{ display:flex; justify-content:space-between; align-items:center; padding:6px 8px; background:#f1f3f5; border-radius:6px; margin:6px 0; }
  .btn-excluir{ width:34px; height:34px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:#dc3545; color:#fff; border:none; cursor:pointer; }
  .muted{ font-size:12px; color:#666; margin-top:6px; text-transform:none; }
  @media(max-width:420px){ .container{padding:16px} h2{font-size:1.1rem} }
</style>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase (modular, via modules import) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push, set, get, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // --- CONFIGURA√á√ÉO FIREBASE (use seu projeto) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDH9MG50ynnt4SiXGAFymBH9nXmBqLwTtU",
    authDomain: "funcionarios-7c778.firebaseapp.com",
    databaseURL: "https://funcionarios-7c778-default-rtdb.firebaseio.com/",
    projectId: "funcionarios-7c778",
    storageBucket: "funcionarios-7c778.firebasestorage.app",
    messagingSenderId: "632364021109",
    appId: "1:632364021109:web:f140b97a8dbc36148b4f3c",
    measurementId: "G-2JXX10SBVG"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Expor fun√ß√µes/refs √∫teis para o c√≥digo abaixo (escopo do m√≥dulo)
  window.__DB = { db, ref, push, set, get, onValue, remove };
</script>
</head>
<body>

<!-- LOGIN -->
<div class="container" id="loginContainer">
  <h2>Login</h2>
  <input id="loginUsuario" placeholder="Usu√°rio" />
  <input id="loginSenha" type="password" placeholder="Senha" />
  <button id="btnEntrar">Entrar</button>
  <p class="muted">usu√°rio: <b>ADMIN</b> / senha: <b>1234</b></p>
</div>

<!-- MENU -->
<div class="container hidden" id="menu">
  <h2>Menu Principal</h2>
  <button id="btnCadastro">Cadastro</button>
  <button id="btnLancamento">Lan√ßamento</button>
  <button id="btnRelatorio">Gerar Relat√≥rio (PDF)</button>
  <button class="btn-voltar" id="btnSair">Sair</button>
</div>

<!-- MENU CADASTRO -->
<div class="container hidden" id="menuCadastro">
  <h2>Cadastro</h2>
  <button id="btnInserir">Inserir</button>
  <button id="btnConsultar">Consultar</button>
  <button class="btn-voltar" id="btnVoltarMenu">Voltar</button>
</div>

<!-- INSERIR FUNCION√ÅRIO -->
<div class="container hidden" id="inserir">
  <h2>Inserir Funcion√°rio</h2>
  <input id="nome" placeholder="Nome" />
  <input id="cargo" placeholder="Cargo" />
  <button id="btnSalvarFuncionario">Salvar</button>
  <button class="btn-voltar" id="btnVoltarCadastro">Voltar</button>
</div>

<!-- CONSULTAR FUNCION√ÅRIOS -->
<div class="container hidden" id="consultar">
  <h2>Funcion√°rios</h2>
  <input id="filtroFuncionarios" placeholder="Filtrar por nome" />
  <div class="lista" id="listaFuncionarios"></div>
  <button class="btn-voltar" id="btnVoltarConsulta">Voltar</button>
</div>

<!-- MENU LAN√áAMENTO -->
<div class="container hidden" id="menuLancamento">
  <h2>Lan√ßamentos</h2>
  <button id="btnInserirLanc">Inserir</button>
  <button id="btnConsultarLanc">Consultar</button>
  <button class="btn-voltar" id="btnVoltarMenuLanc">Voltar</button>
</div>

<!-- INSERIR LAN√áAMENTO -->
<div class="container hidden" id="inserirLanc">
  <h2>Novo Lan√ßamento</h2>
  <select id="tipoLanc">
    <option value="">SELECIONE TIPO</option>
    <option value="VALE">VALE</option>
    <option value="COMPRA">COMPRA</option>
  </select>

  <!-- datalist com nomes dos funcion√°rios -->
  <input list="datalistFuncionarios" id="nomeLanc" placeholder="Nome do Funcion√°rio" />
  <datalist id="datalistFuncionarios"></datalist>

  <input id="dataLanc" type="date" />
  <input id="valorLanc" type="number" step="0.01" placeholder="Valor (Ex: 50.00)" />
  <button id="btnSalvarLanc">Salvar</button>
  <button class="btn-voltar" id="btnVoltarLancamento">Voltar</button>
</div>

<!-- CONSULTAR LAN√áAMENTOS -->
<div class="container hidden" id="consultarLanc">
  <h2>Consultar Lan√ßamentos</h2>
  <input type="month" id="filtroMes" />
  <input id="filtroLancNome" placeholder="Filtrar por nome" />
  <div class="lista" id="listaLancamentos"></div>
  <button class="btn-voltar" id="btnVoltarConsultaLanc">Voltar</button>
</div>

<script>
/* ---------------- UI navigation ---------------- */
function esconderTudo(){ document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden')); }
function mostrar(id){ esconderTudo(); document.getElementById(id).classList.remove('hidden'); }

/* --- login --- */
document.getElementById('btnEntrar').addEventListener('click', ()=> {
  const u = (document.getElementById('loginUsuario').value||'').trim().toUpperCase();
  const s = (document.getElementById('loginSenha').value||'').trim();
  if(u === 'ADMIN' && s === '1234'){ mostrar('menu'); } else alert('Usu√°rio ou senha incorretos!');
});

/* --- menu principal --- */
document.getElementById('btnCadastro').onclick = ()=> mostrar('menuCadastro');
document.getElementById('btnLancamento').onclick = ()=> mostrar('menuLancamento');
document.getElementById('btnSair').onclick = ()=> mostrar('loginContainer');
document.getElementById('btnRelatorio').onclick = gerarPDFRelatorio;

/* --- menu cadastro --- */
document.getElementById('btnInserir').onclick = ()=> { mostrar('inserir'); };
document.getElementById('btnConsultar').onclick = ()=> { mostrar('consultar'); carregarFuncionarios(); };
document.getElementById('btnVoltarMenu').onclick = ()=> mostrar('menu');
document.getElementById('btnVoltarCadastro').onclick = ()=> mostrar('menuCadastro');
document.getElementById('btnVoltarConsulta').onclick = ()=> mostrar('menuCadastro');

/* --- menu lancamento --- */
document.getElementById('btnInserirLanc').onclick = ()=> { atualizarDatalistFuncionarios(); mostrar('inserirLanc'); };
document.getElementById('btnConsultarLanc').onclick = ()=> { mostrar('consultarLanc'); carregarLancamentos(); };
document.getElementById('btnVoltarMenuLanc').onclick = ()=> mostrar('menu');
document.getElementById('btnVoltarLancamento').onclick = ()=> mostrar('menuLancamento');
document.getElementById('btnVoltarConsultaLanc').onclick = ()=> mostrar('menuLancamento');

/* ---------------- Firebase helpers ---------------- */
function dbRef(path){ return window.__DB.ref(window.__DB.db, path); }
const { db, ref, push, set, get, onValue, remove } = window.__DB;

/* ---------------- Funcion√°rios (n√≥: "funcionarios") ---------------- */
document.getElementById('btnSalvarFuncionario').addEventListener('click', async ()=>{
  const nome = (document.getElementById('nome').value||'').trim().toUpperCase();
  const cargo = (document.getElementById('cargo').value||'').trim().toUpperCase();
  if(!nome || !cargo){ alert('Preencha todos os campos.'); return; }
  await push(ref(db, 'funcionarios'), { nome, cargo });
  alert('Funcion√°rio salvo!');
  document.getElementById('nome').value=''; document.getElementById('cargo').value='';
});

function carregarFuncionarios(){
  const lista = document.getElementById('listaFuncionarios');
  const filtro = document.getElementById('filtroFuncionarios');
  const q = ref(db, 'funcionarios');
  // remover listeners anteriores, depois registrar
  onValue(q, snap=>{
    lista.innerHTML = '';
    // popular datalist tamb√©m (usado por lan√ßamentos)
    const dl = document.getElementById('datalistFuncionarios');
    dl.innerHTML = '';
    snap.forEach(child=>{
      const d = child.val();
      const nome = d.nome || '';
      const cargo = d.cargo || '';
      // filtro visual
      const termo = (filtro.value||'').trim().toUpperCase();
      if(!termo || nome.includes(termo)){
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<span><b>${nome}</b> - ${cargo}</span>
          <button class="btn-excluir" onclick="excluirFuncionario('${child.key}')">üóëÔ∏è</button>`;
        lista.appendChild(div);
      }
      // datalist option
      const opt = document.createElement('option'); opt.value = nome;
      dl.appendChild(opt);
    });
  });
}

window.excluirFuncionario = async function(id){
  if(!confirm('Excluir este funcion√°rio?')) return;
  await remove(ref(db, 'funcionarios/' + id));
};

/* datalist update (sincronia simples) */
function atualizarDatalistFuncionarios(){
  get(ref(db, 'funcionarios')).then(snap=>{
    const dl = document.getElementById('datalistFuncionarios');
    dl.innerHTML = '';
    snap.forEach(ch=>{
      const n = ch.val().nome || '';
      const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt);
    });
  });
}

/* ---------------- Lan√ßamentos (n√≥: "lancamentos") ---------------- */
document.getElementById('btnSalvarLanc').addEventListener('click', async ()=>{
  const tipo = (document.getElementById('tipoLanc').value||'').trim();
  const nome = (document.getElementById('nomeLanc').value||'').trim().toUpperCase();
  const data = (document.getElementById('dataLanc').value||'').trim();
  const valor = parseFloat((document.getElementById('valorLanc').value||'').replace(',', '.'));
  if(!tipo || !nome || !data || isNaN(valor)){ alert('Preencha todos os campos corretamente.'); return; }

  // opcional: verificar se funcion√°rio existe
  const funcsSnap = await get(ref(db, 'funcionarios'));
  let existe = false;
  funcsSnap.forEach(ch => { if((ch.val().nome||'').toUpperCase() === nome) existe = true; });
  if(!existe){ if(!confirm('Funcion√°rio n√£o encontrado. Deseja salvar o lan√ßamento mesmo assim?')) return; }

  await push(ref(db, 'lancamentos'), { tipo, nome, data, valor: parseFloat(valor.toFixed(2)) });
  alert('Lan√ßamento salvo!');
  document.getElementById('tipoLanc').value=''; document.getElementById('nomeLanc').value=''; document.getElementById('dataLanc').value=''; document.getElementById('valorLanc').value='';
});

function carregarLancamentos(){
  const lista = document.getElementById('listaLancamentos');
  const filtroMes = document.getElementById('filtroMes').value; // YYYY-MM
  const filtroNome = (document.getElementById('filtroLancNome').value||'').trim().toUpperCase();
  onValue(ref(db, 'lancamentos'), snap=>{
    lista.innerHTML = '';
    snap.forEach(child=>{
      const l = child.val();
      const okMes = !filtroMes || (l.data && l.data.startsWith(filtroMes));
      const okNome = !filtroNome || (l.nome && l.nome.includes(filtroNome));
      if(okMes && okNome){
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<span><b>${l.tipo}</b> | ${l.nome} | ${l.data} | R$ ${Number(l.valor).toFixed(2).replace('.',',')}</span>
          <button class="btn-excluir" onclick="excluirLancamento('${child.key}')">üóëÔ∏è</button>`;
        lista.appendChild(div);
      }
    });
  });
}

window.excluirLancamento = async function(id){
  if(!confirm('Excluir este lan√ßamento?')) return;
  await remove(ref(db, 'lancamentos/' + id));
};

/* ---------------- Gerar PDF dos lan√ßamentos ---------------- */
async function gerarPDFRelatorio(){
  // buscar lan√ßamentos do n√≥ "lancamentos"
  const snap = await get(ref(db, 'lancamentos'));
  const dados = snap.exists() ? snap.val() : {};
  const arr = Object.values(dados);
  if(arr.length === 0){ alert('Nenhum lan√ßamento encontrado.'); return; }

  // agrupar por funcion√°rio (nome)
  const resumo = {};
  arr.forEach(l => {
    const nome = (l.nome || '---').toUpperCase();
    resumo[nome] = (resumo[nome] || 0) + Number(l.valor || 0);
  });

  // gerar pdf com jsPDF (com pontos entre nome e valor)
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const pageW = pdf.internal.pageSize.getWidth();
  pdf.setFontSize(14);
  pdf.setFont("helvetica", "bold");
  const title = "RESUMO DE LAN√áAMENTOS";
  const titleW = pdf.getTextWidth(title);
  pdf.text(title, (pageW - titleW) / 2, 14);

  pdf.setFontSize(10);
  pdf.setFont("helvetica","normal");
  const now = new Date();
  pdf.text(now.toLocaleString('pt-BR'), 10, 20);
  pdf.line(10, 22, pageW - 10, 22);

  let y = 30;
  pdf.setFontSize(12);
  pdf.setFont("helvetica","bold");
  pdf.text("TOTAL POR FUNCION√ÅRIO", 10, y); y += 8;
  pdf.setFont("helvetica","normal");

  const nomes = Object.keys(resumo).sort();
  nomes.forEach(nome => {
    const valor = "R$ " + resumo[nome].toFixed(2).replace('.',',');
    const leftX = 10;
    const rightX = pageW - 10;
    const nomeW = pdf.getTextWidth(nome);
    const valorW = pdf.getTextWidth(valor);
    const dotsW = rightX - leftX - nomeW - valorW - 8;
    const dotW = pdf.getTextWidth('.');
    const countDots = Math.max(3, Math.floor(dotsW / dotW));
    const dots = '.'.repeat(countDots);
    pdf.text(`${nome} ${dots} ${valor}`, leftX, y);
    y += 8;
    if(y > 280){ pdf.addPage(); y = 20; }
  });

  // total geral
  const totalGeral = nomes.reduce((s, n) => s + resumo[n], 0);
  y += 8;
  pdf.setFont("helvetica","bold");
  const totalTxt = "TOTAL GERAL";
  const totalVal = "R$ " + totalGeral.toFixed(2).replace('.',',');
  const leftX = 10;
  const rightX = pageW - 10;
  const totalTxtW = pdf.getTextWidth(totalTxt);
  const totalValW = pdf.getTextWidth(totalVal);
  const dotsW = rightX - leftX - totalTxtW - totalValW - 8;
  const dotW = pdf.getTextWidth('.');
  const countDots = Math.max(3, Math.floor(dotsW / dotW));
  pdf.text(`${totalTxt} ${'.'.repeat(countDots)} ${totalVal}`, leftX, y);

  pdf.save('RESUMO_LANCAMENTOS.pdf');
}

/* ---------------- Inicializa√ß√£o: foco no login ---------------- */
window.addEventListener('load', ()=> {
  document.getElementById('loginUsuario').focus();
});
</script>
</body>
</html>
