<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Corre√ß√£o ‚Äî Lan√ßamentos</title>
<style>
/* (estilos omitidos para brevidade ‚Äî mantenha os seus est√°ticos se preferir) */
body{font-family:Arial, sans-serif;background:#f4f4f4;margin:0;padding:10px;min-height:100vh;display:flex;align-items:center;justify-content:center;box-sizing:border-box;text-transform:uppercase}
.container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.12);width:100%;max-width:420px;box-sizing:border-box}
.hidden{display:none}
.item{background:#f1f3f5;padding:8px;border-radius:6px;margin:6px 0;display:flex;justify-content:space-between;align-items:center}
.btn-excluir{width:34px;height:34px;border-radius:50%;background:#dc3545;color:#fff;border:none;cursor:pointer}
button{background:#007bff;color:#fff;border:none;padding:10px;border-radius:6px}
</style>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- minimal HTML relevant -->
<div class="container" id="loginContainer"><h2>Login</h2>
  <input id="loginUsuario" placeholder="Usu√°rio"/><input id="loginSenha" placeholder="Senha" type="password"/>
  <button id="btnEntrar">Entrar</button>
</div>

<div class="container hidden" id="menu"><h2>Menu</h2>
  <button id="btnLancamento">Lan√ßamento</button>
</div>

<!-- menu lancamento -->
<div class="container hidden" id="menuLancamento">
  <h2>Lan√ßamentos</h2>
  <button id="btnInserirLanc">Inserir</button>
  <button id="btnConsultarLanc">Consultar</button>
  <button id="btnVoltarMenuLanc">Voltar</button>
</div>

<!-- inserir lancamento -->
<div class="container hidden" id="inserirLanc">
  <h2>Inserir / Editar Lan√ßamento</h2>
  <input type="hidden" id="idLancEditando" />
  <select id="tipoLanc">
    <option value="">SELECIONE TIPO</option>
    <option value="VALE">VALE</option>
    <option value="COMPRA">COMPRA</option>
  </select>
  <input list="datalistFuncionarios" id="nomeLanc" placeholder="Nome do Funcion√°rio" />
  <datalist id="datalistFuncionarios"></datalist>
  <input id="dataLanc" type="date" />
  <input id="valorLanc" type="number" step="0.01" placeholder="Valor (Ex: 50.00)" />
  <button id="btnSalvarLanc">Salvar</button>
  <button id="btnVoltarLanc">Voltar</button>
</div>

<!-- consultar lanc -->
<div class="container hidden" id="consultarLanc">
  <h2>Consultar Lan√ßamentos</h2>
  <input type="month" id="filtroMes" />
  <input id="filtroLancNome" placeholder="Filtrar por nome" />
  <div class="lista" id="listaLancamentos"></div>
  <button id="btnVoltarConsultaLanc">Voltar</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* ========== CONFIG FIREBASE ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDH9MG50ynnt4SiXGAFymBH9nXmBqLwTtU",
  authDomain: "funcionarios-7c778.firebaseapp.com",
  databaseURL: "https://funcionarios-7c778-default-rtdb.firebaseio.com/",
  projectId: "funcionarios-7c778",
  storageBucket: "funcionarios-7c778.firebasestorage.app",
  messagingSenderId: "632364021109",
  appId: "1:632364021109:web:f140b97a8dbc36148b4f3c",
  measurementId: "G-2JXX10SBVG"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ========== HELPERS UI ========== */
const $ = id => document.getElementById(id);
function esconderTudo(){ document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden')); }
function mostrar(id){ esconderTudo(); $(id).classList.remove('hidden'); }

/* foco no login */
function focarLogin(){ setTimeout(()=>{ try{ $('loginUsuario').focus(); }catch(e){} }, 150); }
window.addEventListener('load', ()=>{ mostrar('loginContainer'); focarLogin(); });

/* Enter navigation (next / click last) */
document.addEventListener('keydown', function(e){
  if(e.key !== 'Enter') return;
  const interactive = Array.from(document.querySelectorAll('input, select, button'))
    .filter(el => el.offsetParent !== null && !el.disabled && el.type !== 'hidden');
  const idx = interactive.indexOf(e.target);
  if(idx === -1) return;
  e.preventDefault();
  const next = interactive[idx + 1];
  if(next) next.focus();
  else if(e.target && typeof e.target.click === 'function') e.target.click();
});

/* ========== NAV / LOGIN ========== */
$('btnEntrar').addEventListener('click', ()=> {
  const u = ($('loginUsuario').value||'').trim().toUpperCase();
  const s = ($('loginSenha').value||'').trim();
  if(u === 'ADMIN' && s === '1234') { mostrar('menu'); }
  else { alert('Usu√°rio ou senha incorretos!'); focarLogin(); }
});

$('btnLancamento').addEventListener('click', ()=> mostrar('menuLancamento'));

/* volta menu */
$('btnVoltarMenuLanc').addEventListener('click', ()=> mostrar('menu'));

/* abrir inserir/consultar */
$('btnInserirLanc').addEventListener('click', async ()=> {
  await atualizarDatalistFuncionarios();
  // garantir que idLancEditando esteja vazio para criar novo
  $('idLancEditando').value = '';
  mostrar('inserirLanc');
  // focar no primeiro campo (tipo)
  setTimeout(()=> $('tipoLanc').focus(), 80);
});
$('btnConsultarLanc').addEventListener('click', ()=> { mostrar('consultarLanc'); carregarLancamentos(); });

$('btnVoltarLanc').addEventListener('click', ()=> { mostrar('menuLancamento'); });
$('btnVoltarConsultaLanc').addEventListener('click', ()=> { mostrar('menuLancamento'); });


/* ========== FUN√á√ïES: LAN√áAMENTO ========== */

/**
 * salvarLancamento: cria novo ou atualiza existente conforme idLancEditando
 */
$('btnSalvarLanc').addEventListener('click', async ()=> {
  const tipo = ($('tipoLanc').value||'').trim();
  const nome = ($('nomeLanc').value||'').trim().toUpperCase();
  const data = ($('dataLanc').value||'').trim();
  const valorRaw = ($('valorLanc').value||'').toString().replace(',', '.').trim();
  const valor = parseFloat(valorRaw);

  if(!tipo || !nome || !data || isNaN(valor)){
    alert('Preencha todos os campos corretamente.');
    return;
  }

  const idEdit = $('idLancEditando').value;
  const lancRef = ref(db, 'lancamentos');

  if(idEdit){
    // atualizar
    await update(ref(db, `lancamentos/${idEdit}`), { tipo, nome, data, valor: parseFloat(valor.toFixed(2)) });
    alert('Lan√ßamento atualizado!');
    $('idLancEditando').value = '';
  } else {
    // novo
    const node = push(lancRef);
    await set(node, { tipo, nome, data, valor: parseFloat(valor.toFixed(2)) });
    alert('Lan√ßamento salvo!');
  }

  // limpar e voltar para menu de lan√ßamentos
  $('tipoLanc').value=''; $('nomeLanc').value=''; $('dataLanc').value=''; $('valorLanc').value='';
  mostrar('menuLancamento');
});

/**
 * carregarLancamentos: mostra lista com filtros aplicados (real-time)
 */
function carregarLancamentos(){
  const lista = $('listaLancamentos');
  const filtroMes = $('filtroMes').value;
  const filtroNome = ($('filtroLancNome').value||'').trim().toUpperCase();
  lista.innerHTML = '';

  onValue(ref(db, 'lancamentos'), snapshot => {
    lista.innerHTML = '';
    snapshot.forEach(ch => {
      const id = ch.key;
      const l = ch.val();
      const okMes = !filtroMes || (l.data && l.data.startsWith(filtroMes));
      const okNome = !filtroNome || (l.nome && l.nome.includes(filtroNome));
      if(okMes && okNome){
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<span ondblclick="editarLancamento('${id}')"><strong>${l.tipo}</strong> | ${l.nome} | ${l.data} | R$ ${Number(l.valor).toFixed(2).replace('.', ',')}</span>
                         <button class="btn-excluir" onclick="excluirLancamento('${id}')">üóëÔ∏è</button>`;
        lista.appendChild(div);
      }
    });
  });
}

/**
 * editarLancamento: preenche o formul√°rio com os dados existentes
 * - preenche idLancEditando
 * - coloca o nome no topo do datalist (faz com que apare√ßa "em cima")
 * - mostra tela de inserir/editar e foca no tipo
 */
window.editarLancamento = async function(id){
  try {
    const snap = await get(ref(db, `lancamentos/${id}`));
    if(!snap.exists()) { alert('Lan√ßamento n√£o encontrado.'); return; }
    const l = snap.val();

    // preencher campos
    $('idLancEditando').value = id;
    $('tipoLanc').value = l.tipo || '';
    // colocar o nome em cima do datalist: criar option em primeiro lugar
    const dl = $('datalistFuncionarios');
    // limpa e recria com o nome editado em primeiro
    const nomesSnap = await get(ref(db, 'funcionarios'));
    dl.innerHTML = '';
    // cria primeiro o nome do lan√ßamento editado (se n√£o vazio)
    if(l.nome){
      const optEdited = document.createElement('option'); optEdited.value = l.nome; dl.appendChild(optEdited);
    }
    // depois adiciona os demais funcion√°rios (sem duplicar)
    const added = new Set([ (l.nome||'').toUpperCase() ]);
    nomesSnap.forEach(ch => {
      const n = (ch.val().nome||'').toUpperCase();
      if(!added.has(n)){
        const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt);
        added.add(n);
      }
    });

    $('nomeLanc').value = l.nome || '';
    $('dataLanc').value = l.data || '';
    $('valorLanc').value = l.valor || '';

    // mostrar formul√°rio de edi√ß√£o e focar no tipo (ou no nome se preferir)
    mostrar('inserirLanc');
    setTimeout(()=> $('tipoLanc').focus(), 80);
  } catch(err) {
    console.error(err);
    alert('Erro ao carregar lan√ßamento para edi√ß√£o.');
  }
};

/**
 * excluirLancamento
 */
window.excluirLancamento = async function(id){
  if(!confirm('Excluir este lan√ßamento?')) return;
  await remove(ref(db, `lancamentos/${id}`));
  // o onValue que popula a lista vai atualizar automaticamente
};

/**
 * atualizarDatalistFuncionarios: atualiza o datalist com nomes do n√≥ /funcionarios
 */
async function atualizarDatalistFuncionarios(){
  const snap = await get(ref(db, 'funcionarios'));
  const dl = $('datalistFuncionarios');
  dl.innerHTML = '';
  snap.forEach(ch => {
    const n = ch.val().nome || '';
    const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt);
  });
}

/* --------- Utilit√°rios Firebase importados no topo j√°: get, ref, etc.  --------- */
import { get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* Observa√ß√£o: se seu bundler reclamar do import get acima, substitua a linha
   por: const { get } = window.__firebaseHelpers; // mas no ambiente do browser modular funciona.
*/

/* Inicial: nada mais ‚Äî quando usu√°rio abrir tela de consultar, chamar carregarLancamentos() */
</script>
</body>
</html>
