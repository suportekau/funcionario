<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sistema Simples - Funcionários</title>
  <meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --accent:#2b7cff; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter, system-ui, Arial, sans-serif;
      background:var(--bg);
      margin:0; padding:16px;
      color:#111;
    }
    header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    h1{font-size:20px;margin:0}
    .wrap{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){ .wrap{grid-template-columns:360px 1fr} }

    .card{
      background:var(--card);
      border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(20,30,60,0.06);
    }

    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input, select{width:100%;padding:9px;border-radius:8px;border:1px solid #e6e9ef;font-size:15px}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    button{background:var(--accent);color:#fff;border:0;padding:9px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #e6e9ef}
    .small{font-size:13px;padding:7px 10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #f0f2f5;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:6px}
    .right{display:flex;gap:8px;justify-content:flex-end;align-items:center}

    /* modal simples */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.show{display:flex}
    .modal .card{max-width:560px;width:100%}

    footer{margin-top:14px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <h1>Sistema Simples — Funcionários</h1>
    <div class="right" style="margin-left:auto">
      <button id="btn-open-cad" class="small">Cadastro</button>
      <button id="btn-open-lanc" class="small ghost">Lançamento</button>
      <button id="btn-refresh" title="Forçar atualização" class="small">⟳</button>
    </div>
  </header>

  <div class="wrap">
    <!-- painel esquerdo: formulário / controles -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <strong>Controles</strong>
        <span class="muted" style="margin-left:auto" id="status">Conectando...</span>
      </div>

      <div style="margin-bottom:12px">
        <label for="search">Pesquisar (nome ou cargo)</label>
        <input id="search" placeholder="Procure um funcionário..." />
      </div>

      <div>
        <label>Funcionários</label>
        <div id="func-list" style="max-height:380px;overflow:auto"></div>
      </div>
    </div>

    <!-- painel direito: tabelas -->
    <div>
      <div class="card" style="margin-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <strong>Últimos Lançamentos</strong>
          <div class="muted" id="lcount">0</div>
        </div>
        <div id="lanc-table-container"></div>
      </div>

      <div class="card">
        <strong>Todos Funcionários</strong>
        <div id="func-table-container"></div>
      </div>
    </div>
  </div>

  <!-- modal cadastro -->
  <div id="modal-cad" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Novo Funcionário</h3>
      <div style="margin-top:8px">
        <label for="nome">Nome</label>
        <input id="nome" autocomplete="off" />
      </div>
      <div style="margin-top:8px">
        <label for="cargo">Cargo</label>
        <input id="cargo" autocomplete="off" />
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="btn-cad-cancel" class="ghost">Cancelar</button>
        <button id="btn-cad-save">Salvar</button>
      </div>
    </div>
  </div>

  <!-- modal lançamento -->
  <div id="modal-lanc" class="modal" aria-hidden="true">
    <div class="card">
      <h3>Novo Lançamento</h3>

      <div style="margin-top:8px">
        <label for="sel-func">Funcionário</label>
        <select id="sel-func"></select>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label for="data">Data</label>
          <input id="data" type="date" />
        </div>
        <div class="col">
          <label for="tipo">Tipo</label>
          <select id="tipo">
            <option value="salario">Salário</option>
            <option value="despesa">Despesa</option>
            <option value="bonus">Bônus</option>
          </select>
        </div>
      </div>

      <div style="margin-top:8px">
        <label for="valor">Valor</label>
        <input id="valor" type="number" step="0.01" />
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="btn-lanc-cancel" class="ghost">Cancelar</button>
        <button id="btn-lanc-save">Salvar</button>
      </div>
    </div>
  </div>

  <footer class="muted">Hospedado no GitHub Pages • Realtime via Firebase Realtime DB</footer>

<script>
/*
  SISTEMA SIMPLES - Funcionários (client-only)
  - Usa Firebase Realtime Database via REST + EventSource para ouvir mudanças.
  - EDITAR: se necessário, altere BASE_URL para o seu DB.
*/

const BASE_URL = 'https://funcionarios-7c778-default-rtdb.firebaseio.com'; // já fornecido
// paths
const PATH_FUNC = '/funcionarios';
const PATH_LANC = '/lancamentos';

// elementos
const modalCad = document.getElementById('modal-cad');
const modalLanc = document.getElementById('modal-lanc');
const btnOpenCad = document.getElementById('btn-open-cad');
const btnOpenLanc = document.getElementById('btn-open-lanc');
const btnRefresh = document.getElementById('btn-refresh');
const statusEl = document.getElementById('status');

const nomeIn = document.getElementById('nome');
const cargoIn = document.getElementById('cargo');
const btnCadSave = document.getElementById('btn-cad-save');
const btnCadCancel = document.getElementById('btn-cad-cancel');

const selFunc = document.getElementById('sel-func');
const dataIn = document.getElementById('data');
const tipoIn = document.getElementById('tipo');
const valorIn = document.getElementById('valor');
const btnLancSave = document.getElementById('btn-lanc-save');
const btnLancCancel = document.getElementById('btn-lanc-cancel');

const funcList = document.getElementById('func-list');
const funcTableContainer = document.getElementById('func-table-container');
const lancTableContainer = document.getElementById('lanc-table-container');
const lcount = document.getElementById('lcount');
const searchInput = document.getElementById('search');

// estado local
let funcionarios = {}; // {id: {nome,cargo}}
let lancamentos = {};  // {id: {funcId,data,tipo,valor}}
let esFunc = null, esLanc = null;

// util
function url(path){ return `${BASE_URL}${path}.json`; }
function nowDateISO(){ return new Date().toISOString(); }
function formatDate(d){
  if(!d) return '';
  const D = new Date(d);
  if(isNaN(D)) return d;
  return D.toLocaleDateString();
}

// CRUD usando REST
async function addFuncionario(obj){
  const res = await fetch(url(PATH_FUNC), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(obj)
  });
  return res.json();
}
async function addLancamento(obj){
  const res = await fetch(url(PATH_LANC), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(obj)
  });
  return res.json();
}
async function deleteFuncionario(id){
  await fetch(url(PATH_FUNC + '/' + id), { method:'DELETE' });
}
async function deleteLanc(id){
  await fetch(url(PATH_LANC + '/' + id), { method:'DELETE' });
}

// render
function renderFuncionariosList(filter=''){
  funcList.innerHTML = '';
  const keys = Object.keys(funcionarios).sort((a,b)=>{
    const A = (funcionarios[a]?.nome||'').toLowerCase();
    const B = (funcionarios[b]?.nome||'').toLowerCase();
    return A.localeCompare(B);
  });
  const f = filter.trim().toLowerCase();
  for(const k of keys){
    const it = funcionarios[k];
    if(f && !(it.nome.toLowerCase().includes(f) || (it.cargo||'').toLowerCase().includes(f))) continue;
    const div = document.createElement('div');
    div.style.padding='8px';
    div.style.borderBottom='1px solid #f0f2f5';
    div.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <div style="font-weight:600">${escapeHtml(it.nome)}</div>
        <div class="muted" style="font-size:13px">${escapeHtml(it.cargo||'')}</div>
      </div>
      <div class="actions">
        <button class="ghost small" onclick="handleDelFunc('${k}')">Excluir</button>
      </div>
    </div>`;
    funcList.appendChild(div);
  }
}

function renderFuncTable(){
  const keys = Object.keys(funcionarios);
  let html = `<table><thead><tr><th>Nome</th><th>Cargo</th><th></th></tr></thead><tbody>`;
  for(const k of keys){
    const it = funcionarios[k];
    html += `<tr>
      <td>${escapeHtml(it.nome)}</td>
      <td>${escapeHtml(it.cargo||'')}</td>
      <td class="right"><button class="ghost small" onclick="handleDelFunc('${k}')">Excluir</button></td>
    </tr>`;
  }
  html += `</tbody></table>`;
  funcTableContainer.innerHTML = html;
  // repopula select para lançamento
  selFunc.innerHTML = '<option value="">-- selecione --</option>';
  for(const k of keys){
    const it = funcionarios[k];
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = it.nome;
    selFunc.appendChild(opt);
  }
}

function renderLancTable(){
  const keys = Object.keys(lancamentos).sort((a,b)=>{
    return (lancamentos[b]?.data||'').localeCompare(lancamentos[a]?.data||'');
  });
  lcount.textContent = keys.length;
  let html = `<table><thead><tr><th>Data</th><th>Funcionário</th><th>Tipo</th><th>Valor</th><th></th></tr></thead><tbody>`;
  for(const k of keys){
    const it = lancamentos[k];
    const fn = funcionarios[it.funcId]?.nome || '[ex-func]';
    html += `<tr>
      <td>${escapeHtml(formatDate(it.data))}</td>
      <td>${escapeHtml(fn)}</td>
      <td>${escapeHtml(it.tipo)}</td>
      <td>R$ ${Number(it.valor||0).toFixed(2)}</td>
      <td class="right"><button class="ghost small" onclick="handleDelLanc('${k}')">Excluir</button></td>
    </tr>`;
  }
  html += `</tbody></table>`;
  lancTableContainer.innerHTML = html;
}

// helpers
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// handlers expostos para botões inline no HTML
window.handleDelFunc = async function(id){
  if(!confirm('Excluir funcionário? Isso não apagará lançamentos já feitos (mas ficará sem referência).')) return;
  try{
    await deleteFuncionario(id);
    // UI será atualizada via SSE; força atualização imediata também
    fetchSnapshot();
  }catch(e){ alert('Erro ao excluir'); console.error(e) }
}
window.handleDelLanc = async function(id){
  if(!confirm('Excluir lançamento?')) return;
  try{
    await deleteLanc(id);
    fetchSnapshot();
  }catch(e){ alert('Erro ao excluir lançamento'); console.error(e) }
}

// modais
function openModal(m){
  m.classList.add('show');
  m.setAttribute('aria-hidden','false');
}
function closeModal(m){
  m.classList.remove('show');
  m.setAttribute('aria-hidden','true');
}

// event listeners
btnOpenCad.addEventListener('click', ()=>{
  nomeIn.value=''; cargoIn.value='';
  openModal(modalCad);
  setTimeout(()=> nomeIn.focus(), 60); // foco automático no primeiro campo
});
btnOpenLanc.addEventListener('click', ()=>{
  valorIn.value=''; dataIn.value = new Date().toISOString().slice(0,10);
  tipoIn.value='salario';
  openModal(modalLanc);
  setTimeout(()=> selFunc.focus(), 60);
});
btnCadCancel.addEventListener('click', ()=> closeModal(modalCad));
btnLancCancel.addEventListener('click', ()=> closeModal(modalLanc));

btnCadSave.addEventListener('click', async ()=>{
  const nome = nomeIn.value.trim();
  const cargo = cargoIn.value.trim();
  if(!nome){ alert('Preencha o nome'); nomeIn.focus(); return; }
  btnCadSave.disabled = true;
  try{
    await addFuncionario({ nome, cargo, criadoEm: nowDateISO() });
    closeModal(modalCad);
    // força snapshot curto
    fetchSnapshot();
  }catch(e){
    alert('Erro ao salvar'); console.error(e);
  }finally{ btnCadSave.disabled = false; }
});

btnLancSave.addEventListener('click', async ()=>{
  const funcId = selFunc.value;
  const data = dataIn.value || new Date().toISOString();
  const tipo = tipoIn.value;
  const valor = parseFloat(valorIn.value || 0);
  if(!funcId){ alert('Selecione um funcionário'); selFunc.focus(); return; }
  btnLancSave.disabled = true;
  try{
    await addLancamento({ funcId, data, tipo, valor, criadoEm: nowDateISO() });
    closeModal(modalLanc);
    fetchSnapshot();
  }catch(e){
    alert('Erro ao salvar lançamento'); console.error(e);
  }finally{ btnLancSave.disabled = false; }
});

btnRefresh.addEventListener('click', ()=> fetchSnapshot());

// enter navigation: Enter em inputs move para próximo campo
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    const tag = e.target.tagName.toLowerCase();
    if(tag === 'input' || tag === 'select'){
      e.preventDefault();
      // navega para o próximo focusable
      const focusables = Array.from(document.querySelectorAll('input,select,button')).filter(el => !el.disabled);
      const idx = focusables.indexOf(e.target);
      const next = focusables[idx+1] || focusables[0];
      next.focus();
    }
  }
});

// busca inicial
async function fetchSnapshot(){
  // busca rápido snapshot (não bloqueante)
  try{
    const [rf, rl] = await Promise.all([
      fetch(url(PATH_FUNC)).then(r=>r.json()).catch(()=>{}),
      fetch(url(PATH_LANC)).then(r=>r.json()).catch(()=>{})
    ]);
    funcionarios = rf || {};
    lancamentos = rl || {};
    renderFuncionariosList(searchInput.value || '');
    renderFuncTable();
    renderLancTable();
    statusEl.textContent = 'Atualizado ' + new Date().toLocaleTimeString();
  }catch(e){
    console.error('fetchSnapshot', e);
    statusEl.textContent = 'Erro ao atualizar';
  }
}

// conectar via EventSource (SSE) para updates em tempo real
function connectSSE(){
  // fecha conexões antigas
  try{ if(esFunc) esFunc.close(); }catch(e){}
  try{ if(esLanc) esLanc.close(); }catch(e){}

  // Eventos para path de funcionarios
  try{
    esFunc = new EventSource(`${BASE_URL}${PATH_FUNC}.json`);
    esFunc.onopen = ()=> {
      statusEl.textContent = 'Conectado (funcionários)';
    };
    esFunc.onerror = (e)=>{
      statusEl.textContent = 'Reconectando...';
      console.warn('esFunc erro', e);
    };
    esFunc.onmessage = (evt)=>{
      // evt.data pode vir como "null" ou JSON
      try{
        const data = JSON.parse(evt.data);
        // firebase SSE retorna todo o nó; ao atualizar, data é o mapa atual.
        funcionarios = data || {};
        renderFuncionariosList(searchInput.value || '');
        renderFuncTable();
      }catch(e){ console.error('parse esFunc', e); }
    };
  }catch(e){ console.error('Erro EventSource func', e); statusEl.textContent='SSE não suportado'; }

  // Eventos para path de lancamentos
  try{
    esLanc = new EventSource(`${BASE_URL}${PATH_LANC}.json`);
    esLanc.onopen = ()=> {
      statusEl.textContent = 'Conectado (lançamentos)';
    };
    esLanc.onerror = (e)=>{
      statusEl.textContent = 'Reconectando...';
      console.warn('esLanc erro', e);
    };
    esLanc.onmessage = (evt)=>{
      try{
        const data = JSON.parse(evt.data);
        lancamentos = data || {};
        renderLancTable();
      }catch(e){ console.error('parse esLanc', e); }
    };
  }catch(e){ console.error('Erro EventSource lanc', e); statusEl.textContent='SSE não suportado'; }
}

// busca inicial + sse
fetchSnapshot();
connectSSE();

// busca quando o usuário pesquisa
searchInput.addEventListener('input', ()=> renderFuncionariosList(searchInput.value||''));

// instruções simples: fechar modais ao clicar fora
document.querySelectorAll('.modal').forEach(m=>{
  m.addEventListener('click', (ev)=>{
    if(ev.target === m) closeModal(m);
  });
});

// dica: para forçar ignorar cache do GitHub Pages ao abrir no celular, adicione ?v=NUM no final da URL do site
// ex: https://suportekau.github.io/funcionario/?v=2

</script>
</body>
</html>
