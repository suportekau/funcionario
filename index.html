<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Funcion√°rios - Firestore (Tempo real)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;display:flex;align-items:center;justify-content:center;min-height:100vh;text-transform:uppercase}
    .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.08);width:95%;max-width:380px;text-align:center}
    input,button,select{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc;box-sizing:border-box;font-size:14px;text-transform:uppercase}
    button{background:#007bff;color:#fff;border:0;cursor:pointer}
    button:hover{background:#0056b3}
    .btn-voltar{background:#6c757d}
    .hidden{display:none}
    .lista{max-height:300px;overflow:auto;text-align:left;margin-top:10px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#f1f3f5;margin:6px 0}
    .btn-excluir{background:#dc3545;color:#fff;border:0;border-radius:6px;padding:6px 8px;cursor:pointer}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login" class="card">
    <h2>LOGIN</h2>
    <input id="usuario" type="text" placeholder="Usu√°rio" autofocus />
    <input id="senha" type="password" placeholder="Senha" />
    <button id="btnLogin">Entrar</button>
  </div>

  <!-- MENU PRINCIPAL -->
  <div id="menu" class="card hidden">
    <h2>MENU PRINCIPAL</h2>
    <button id="btnAbrirCadastro">Cadastro</button>
    <button id="btnAbrirLancamento" disabled>Lan√ßamento (opcional)</button>
    <button id="btnSair" class="btn-voltar">Sair</button>
  </div>

  <!-- MENU CADASTRO -->
  <div id="cadastroMenu" class="card hidden">
    <h2>MENU CADASTRO</h2>
    <button id="btnInserir">Inserir Funcion√°rio</button>
    <button id="btnConsultar">Consultar Funcion√°rios</button>
    <button id="btnVoltarMenu" class="btn-voltar">Voltar</button>
  </div>

  <!-- FORMUL√ÅRIO INSERIR / EDITAR -->
  <div id="cadastroForm" class="card hidden">
    <h2 id="formTitulo">INSERIR FUNCION√ÅRIO</h2>
    <input type="hidden" id="idEditando" />
    <input id="nome" type="text" placeholder="Nome" />
    <input id="cargo" type="text" placeholder="Cargo" />
    <button id="btnSalvar">Salvar</button>
    <button id="btnVoltarCadastro" class="btn-voltar">Voltar</button>
  </div>

  <!-- CONSULTA -->
  <div id="consulta" class="card hidden">
    <h2>CONSULTAR FUNCION√ÅRIOS</h2>
    <div id="listaCadastros" class="lista"></div>
    <button id="btnVoltarConsulta" class="btn-voltar">Voltar</button>
  </div>

  <!-- Firebase compat (funciona abrindo o arquivo localmente) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  // ---------- CONFIG FIREBASE ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBQi6DKYqEmkMq19UpgXl1qYg8G3q8Id-w",
    authDomain: "funcionarios-b75f8.firebaseapp.com",
    projectId: "funcionarios-b75f8",
    storageBucket: "funcionarios-b75f8.firebasestorage.app",
    messagingSenderId: "486091546093",
    appId: "1:486091546093:web:4cfa5518f209e5e68edbe4",
    measurementId: "G-R2SYT938ZG"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ---------- ELEMENTOS ----------
  const elLogin = document.getElementById('login');
  const elMenu = document.getElementById('menu');
  const elCadastroMenu = document.getElementById('cadastroMenu');
  const elCadastroForm = document.getElementById('cadastroForm');
  const elConsulta = document.getElementById('consulta');

  const usuarioInput = document.getElementById('usuario');
  const senhaInput = document.getElementById('senha');
  const btnLogin = document.getElementById('btnLogin');
  const btnAbrirCadastro = document.getElementById('btnAbrirCadastro');
  const btnSair = document.getElementById('btnSair');

  const btnInserir = document.getElementById('btnInserir');
  const btnConsultar = document.getElementById('btnConsultar');
  const btnVoltarMenu = document.getElementById('btnVoltarMenu');

  const formTitulo = document.getElementById('formTitulo');
  const idEditandoInput = document.getElementById('idEditando');
  const nomeInput = document.getElementById('nome');
  const cargoInput = document.getElementById('cargo');
  const btnSalvar = document.getElementById('btnSalvar');
  const btnVoltarCadastro = document.getElementById('btnVoltarCadastro');

  const listaCadastros = document.getElementById('listaCadastros');
  const btnVoltarConsulta = document.getElementById('btnVoltarConsulta');

  // helper para esconder tudo
  function esconderTudo(){
    [elLogin,elMenu,elCadastroMenu,elCadastroForm,elConsulta].forEach(x=>x.classList.add('hidden'));
  }

  // ----- foco inicial e uppercase visual -----
  window.addEventListener('load', ()=> usuarioInput.focus());
  document.addEventListener('input', e=>{
    const t = e.target;
    if (!t) return;
    if (t.tagName.toLowerCase()==='input' && t.type==='text') {
      const pos = t.selectionStart;
      t.value = t.value.toUpperCase();
      try{ t.setSelectionRange(pos,pos); }catch(e){}
    }
  });

  // ----- LOGIN -----
  usuarioInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); senhaInput.focus(); }});
  senhaInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); btnLogin.click(); }});
  btnLogin.addEventListener('click', ()=>{
    const user = (usuarioInput.value||'').trim().toUpperCase();
    const pass = (senhaInput.value||'').trim();
    if (user==='ADMIN' && pass==='1234'){ esconderTudo(); elMenu.classList.remove('hidden'); }
    else { alert('Usu√°rio ou senha incorretos!'); usuarioInput.focus(); }
  });
  btnSair.addEventListener('click', ()=> location.reload());

  // ----- MENU -----
  btnAbrirCadastro.addEventListener('click', ()=>{ esconderTudo(); elCadastroMenu.classList.remove('hidden'); });
  btnVoltarMenu.addEventListener('click', ()=>{ esconderTudo(); elMenu.classList.remove('hidden'); });

  // ----- INSERIR -----
  btnInserir.addEventListener('click', ()=>{
    formTitulo.textContent = 'INSERIR FUNCION√ÅRIO';
    idEditandoInput.value = '';
    nomeInput.value = '';
    cargoInput.value = '';
    esconderTudo(); elCadastroForm.classList.remove('hidden');
    nomeInput.focus();
  });
  btnVoltarCadastro.addEventListener('click', ()=>{ esconderTudo(); elCadastroMenu.classList.remove('hidden'); });

  // ----- SALVAR (inserir/atualizar) -----
  async function salvarCadastro(){
    const nome = (nomeInput.value||'').trim();
    const cargo = (cargoInput.value||'').trim();
    if(!nome || !cargo){ alert('Preencha todos os campos!'); nomeInput.focus(); return; }
    const idEdit = idEditandoInput.value;
    try{
      if(idEdit){
        await db.collection('funcionarios').doc(idEdit).update({ nome, cargo });
        alert('Funcion√°rio atualizado!');
      } else {
        await db.collection('funcionarios').add({ nome, cargo });
        alert('Funcion√°rio inserido!');
      }
      // limpa e foca no nome (pronto para novo registro)
      idEditandoInput.value=''; nomeInput.value=''; cargoInput.value=''; nomeInput.focus();
    } catch(err){
      console.error(err);
      alert('Erro ao salvar: ' + (err.message||err));
    }
  }
  btnSalvar.addEventListener('click', e=>{ e.preventDefault(); salvarCadastro(); });

  // Enter navigation inside form: name -> cargo -> save
  nomeInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); cargoInput.focus(); }});
  cargoInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); salvarCadastro(); }});

  // ----- CONSULTA (real-time) -----
  let unsubscribe = null;
  btnConsultar.addEventListener('click', listarFuncionarios);
  btnVoltarConsulta.addEventListener('click', ()=>{
    // remover listener ao sair da consulta
    if (typeof unsubscribe === 'function') unsubscribe();
    unsubscribe = null;
    esconderTudo(); elCadastroMenu.classList.remove('hidden');
  });

  function renderListaFromSnapshot(snapshot){
    listaCadastros.innerHTML = '';
    if (snapshot.empty || snapshot.size===0){ listaCadastros.innerHTML = '<p>Nenhum funcion√°rio cadastrado.</p>'; return; }
    snapshot.forEach(doc => {
      const d = doc.data();
      const id = doc.id;
      const div = document.createElement('div');
      div.className = 'item';
      const span = document.createElement('span');
      span.textContent = `${d.nome} - ${d.cargo}`;
      span.style.cursor = 'pointer';
      span.ondblclick = ()=> editarFuncionario(id);
      const btnDel = document.createElement('button');
      btnDel.className = 'btn-excluir';
      btnDel.textContent = 'üóëÔ∏è';
      btnDel.onclick = async ()=> {
        if(confirm('Excluir este funcion√°rio?')){
          await db.collection('funcionarios').doc(id).delete();
        }
      };
      div.appendChild(span);
      div.appendChild(btnDel);
      listaCadastros.appendChild(div);
    });
  }

  async function listarFuncionarios(){
    esconderTudo(); elConsulta.classList.remove('hidden');
    listaCadastros.innerHTML = '<p>Carregando...</p>';
    // remove listener anterior
    if (typeof unsubscribe === 'function') unsubscribe();
    // onSnapshot retorna a fun√ß√£o unsubscribe
    unsubscribe = db.collection('funcionarios').orderBy('nome').onSnapshot({
      next: snapshot => renderListaFromSnapshot(snapshot),
      error: err => { console.error('snapshot error', err); listaCadastros.innerHTML = '<p>Erro ao carregar.</p>'; }
    });
  }

  // ----- EDITAR -----
  async function editarFuncionario(id){
    try{
      const docSnap = await db.collection('funcionarios').doc(id).get();
      if (!docSnap.exists) { alert('Registro n√£o encontrado'); return; }
      const d = docSnap.data();
      formTitulo.textContent = 'EDITAR FUNCION√ÅRIO';
      idEditandoInput.value = id;
      nomeInput.value = d.nome || '';
      cargoInput.value = d.cargo || '';
      // abrir formul√°rio e focar
      esconderTudo(); elCadastroForm.classList.remove('hidden'); nomeInput.focus();
    }catch(err){
      console.error(err);
      alert('Erro ao carregar para edi√ß√£o: ' + (err.message||err));
    }
  }

  // Cleanup when user closes tab (unsubscribe)
  window.addEventListener('beforeunload', ()=> { if(typeof unsubscribe==='function') unsubscribe(); });

  </script>
</body>
</html>
