<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Simples – Funcionários com Firestore</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      text-transform: uppercase;
      box-sizing: border-box;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      text-align: center;
      width: 100%;
      max-width: 380px;
      box-sizing: border-box;
    }
    h2 { margin-bottom: 20px; font-size: 1.4em; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
      text-transform: uppercase;
    }
    button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background-color: #0056b3; }
    .btn-voltar { background-color: #6c757d; }
    .btn-voltar:hover { background-color: #565e64; }
    .hidden { display: none; }
    .lista { text-align: left; margin-top: 10px; max-height: 250px; overflow-y: auto; }
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f1f3f5;
      padding: 6px 8px;
      border-radius: 6px;
      margin: 4px 0;
      transition: background 0.2s;
    }
    .item:hover { background-color: #e0e3e7; }
    .btn-excluir {
      width: 28px; height: 28px; display:flex; align-items:center; justify-content:center;
      background-color:#dc3545; color:white; border:none; border-radius:50%; cursor:pointer;
      font-size:14px; flex-shrink:0; transition: background .2s, transform .1s;
    }
    .btn-excluir:hover{ background-color:#b02a37; transform: scale(1.1); }
    @media (max-width: 400px) {
      h2 { font-size: 1.2em; }
      button { font-size: 15px; padding: 10px; }
      input, select, textarea { font-size: 15px; padding: 8px; }
    }
  </style>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, updateDoc, deleteDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_PROJETO.firebaseapp.com",
      projectId: "SEU_PROJETO",
      // adicione outras config se necessário (storageBucket, messagingSenderId, etc)
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.firebaseImports = {
      collection, addDoc, doc, onSnapshot, query, orderBy, updateDoc, deleteDoc, getDoc
    };

    window.addEventListener('DOMContentLoaded', () => {
      initSistema();
    });
  </script>
</head>
<body>

  <!-- LOGIN -->
  <div class="container" id="loginContainer">
    <h2>Login</h2>
    <input type="text" id="loginUsuario" placeholder="Usuário" />
    <input type="password" id="loginSenha" placeholder="Senha" />
    <button id="btnEntrar" onclick="fazerLogin()">Entrar</button>
  </div>

  <!-- MENU PRINCIPAL -->
  <div class="container hidden" id="menu">
    <h2>Menu Principal</h2>
    <button onclick="abrirCadastro()">Cadastro</button>
    <button onclick="abrirLancamento()">Lançamento</button>
    <button onclick="sair()">Sair</button>
  </div>

  <!-- MENU CADASTRO -->
  <div class="container hidden" id="menuCadastro">
    <h2>Cadastro</h2>
    <button id="btnInserirCadastro" onclick="abrirInserir()">Inserir</button>
    <button onclick="abrirConsultar()">Consultar</button>
    <button class="btn-voltar" onclick="voltar()">Voltar</button>
  </div>

  <!-- INSERIR CADASTRO -->
  <div class="container hidden" id="inserir">
    <h2>Inserir / Editar Funcionário</h2>
    <input type="hidden" id="idEditando" />
    <input type="text" id="nome" placeholder="Nome" />
    <input type="text" id="cargo" placeholder="Cargo" />
    <button id="btnSalvarCadastro" onclick="salvarCadastroFirestore()">Salvar</button>
    <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
  </div>

  <!-- CONSULTAR CADASTRO -->
  <div class="container hidden" id="consultar">
    <h2>Consultar Funcionários</h2>
    <input type="text" id="filtro" placeholder="Filtrar por nome" oninput="mostrarCadastrosFirestore()" />
    <div class="lista" id="listaCadastros"></div>
    <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
  </div>

  <script>
    const nomeInput = document.getElementById('nome');
    const cargoInput = document.getElementById('cargo');
    const idEditandoInput = document.getElementById('idEditando');

    const {
      collection, addDoc, doc, onSnapshot, query, orderBy,
      updateDoc, deleteDoc, getDoc
    } = window.firebaseImports;

    function initSistema() {
      // Inicializa focos e eventos do formulário inserir cadastro
      const inserirDiv = document.getElementById('inserir');

      // Ao abrir o formulário inserir, foca no primeiro input
      // Por isso criamos a função abrirInserir() com foco.

      // Adiciona evento para navegação com Enter nos campos do cadastro
      const inputs = [nomeInput, cargoInput];
      inputs.forEach((input, idx) => {
        input.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            // Se não for o último campo, vai para o próximo input
            if (idx < inputs.length - 1) {
              inputs[idx + 1].focus();
            } else {
              // Se for o último, chama salvar
              salvarCadastroFirestore();
            }
          }
        });
      });
    }

    // Navegação
    function esconderTudo() {
      document.querySelectorAll('.container').forEach(div => div.classList.add('hidden'));
    }
    function abrirCadastro() {
      esconderTudo();
      document.getElementById('menuCadastro').classList.remove('hidden');
    }
    function abrirLancamento() {
      esconderTudo();
      // Aqui manteria o menu de lançamentos (não mostrado)
    }
    function voltar() {
      esconderTudo();
      document.getElementById('menu').classList.remove('hidden');
    }
    function voltarCadastro() {
      esconderTudo();
      document.getElementById('menuCadastro').classList.remove('hidden');
      limparCamposCadastro();
    }
    function abrirInserir() {
      esconderTudo();
      document.getElementById('inserir').classList.remove('hidden');
      limparCamposCadastro();
      nomeInput.focus();
    }
    function sair() {
      alert('Saindo do sistema...');
      location.reload();
    }

    // LOGIN
    function fazerLogin() {
      const usuario = (document.getElementById('loginUsuario').value || '').trim().toUpperCase();
      const senha = (document.getElementById('loginSenha').value || '').trim();
      if (usuario === 'ADMIN' && senha === '1234') {
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('menu').classList.remove('hidden');
        alert('Login bem‑sucedido!');
        const btn = document.querySelector('#menu button');
        if (btn) btn.focus();
      } else {
        alert('Usuário ou senha incorretos!');
      }
    }

    // Função para limpar campos do cadastro
    function limparCamposCadastro() {
      nomeInput.value = '';
      cargoInput.value = '';
      idEditandoInput.value = '';
    }

    // Salvar no Firestore
    async function salvarCadastroFirestore() {
      const nome = nomeInput.value.trim().toUpperCase();
      const cargo = cargoInput.value.trim().toUpperCase();

      if (!nome) {
        alert('Informe o nome!');
        nomeInput.focus();
        return;
      }
      if (!cargo) {
        alert('Informe o cargo!');
        cargoInput.focus();
        return;
      }

      const idEditando = idEditandoInput.value;

      try {
        if (idEditando) {
          // Atualiza existente
          const docRef = doc(window.db, 'funcionarios', idEditando);
          await updateDoc(docRef, { nome, cargo });
          alert('Funcionário atualizado com sucesso!');
        } else {
          // Cria novo
          const colRef = collection(window.db, 'funcionarios');
          await addDoc(colRef, { nome, cargo });
          alert('Funcionário cadastrado com sucesso!');
        }
        limparCamposCadastro();
        abrirConsultar();
      } catch (error) {
        alert('Erro ao salvar no Firestore: ' + error.message);
      }
    }

    // Consultar e mostrar lista
    async function mostrarCadastrosFirestore() {
      const filtro = (document.getElementById('filtro').value || '').trim().toUpperCase();
      const lista = document.getElementById('listaCadastros');
      lista.innerHTML = 'Carregando...';

      try {
        const colRef = collection(window.db, 'funcionarios');
        const q = query(colRef, orderBy('nome'));
        onSnapshot(q, snapshot => {
          lista.innerHTML = '';
          if (snapshot.empty) {
            lista.innerHTML = '<p>Nenhum funcionário cadastrado.</p>';
            return;
          }
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            if (filtro && !data.nome.includes(filtro)) return;

            const div = document.createElement('div');
            div.classList.add('item');
            div.textContent = `${data.nome} — ${data.cargo}`;

            // Botão excluir
            const btnExcluir = document.createElement('button');
            btnExcluir.textContent = 'X';
            btnExcluir.title = 'Excluir';
            btnExcluir.classList.add('btn-excluir');
            btnExcluir.onclick = async () => {
              if (confirm(`Excluir ${data.nome}?`)) {
                await deleteDoc(doc(window.db, 'funcionarios', docSnap.id));
              }
            };

            // Editar ao clicar no texto
            div.onclick = () => {
              abrirInserir();
              idEditandoInput.value = docSnap.id;
              nomeInput.value = data.nome;
              cargoInput.value = data.cargo;
              nomeInput.focus();
            };

            div.appendChild(btnExcluir);
            lista.appendChild(div);
          });
          if (lista.innerHTML === '') {
            lista.innerHTML = '<p>Nenhum funcionário encontrado.</p>';
          }
        });
      } catch (error) {
        lista.innerHTML = '<p>Erro ao carregar lista: ' + error.message + '</p>';
      }
    }

    // Abrir consulta ao abrir menu cadastro
    document.getElementById('menuCadastro').addEventListener('transitionend', () => {
      if (!document.getElementById('menuCadastro').classList.contains('hidden')) {
        mostrarCadastrosFirestore();
      }
    });

  </script>
</body>
</html>
