<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema Simples - Funcion√°rios (Firebase)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    text-transform: uppercase;
    box-sizing: border-box;
  }
  .container {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    text-align: center;
    width: 100%;
    max-width: 380px;
    box-sizing: border-box;
  }
  h2 { margin-bottom: 20px; font-size: 1.4em; }
  input, select, textarea {
    width: 100%; padding: 10px; margin: 5px 0;
    border-radius: 6px; border: 1px solid #ccc;
    font-size: 16px; box-sizing: border-box;
    text-transform: uppercase;
  }
  button {
    width: 100%; padding: 12px; margin: 8px 0;
    border: none; border-radius: 8px;
    background-color: #007bff; color: white;
    font-size: 16px; cursor: pointer; transition: background 0.2s;
  }
  button:hover { background-color: #0056b3; }
  .btn-voltar { background-color: #6c757d; }
  .btn-voltar:hover { background-color: #565e64; }
  .hidden { display: none; }
  .lista { text-align: left; margin-top: 10px; max-height: 250px; overflow-y: auto; }
  .item {
    display: flex; justify-content: space-between; align-items: center;
    background: #f1f3f5; padding: 6px 8px; border-radius: 6px; margin: 4px 0;
    transition: background 0.2s;
  }
  .item:hover { background-color: #e0e3e7; }
  .btn-excluir {
    width: 28px; height: 28px; display:flex; align-items:center; justify-content:center;
    background-color:#dc3545; color:white; border:none; border-radius:50%; cursor:pointer;
    font-size:14px; flex-shrink:0; transition: background .2s, transform .1s;
  }
  .btn-excluir:hover{ background-color:#b02a37; transform: scale(1.1); }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- LOGIN -->
<div class="container" id="loginContainer">
  <h2>Login</h2>
  <input type="text" id="loginUsuario" placeholder="Usu√°rio" />
  <input type="password" id="loginSenha" placeholder="Senha" />
  <button onclick="fazerLogin()">Entrar</button>
</div>

<!-- MENU PRINCIPAL -->
<div class="container hidden" id="menu">
  <h2>Menu Principal</h2>
  <button onclick="abrirCadastro()">Cadastro</button>
  <button onclick="abrirLancamento()">Lan√ßamento</button>
  <button onclick="sair()">Sair</button>
</div>

<!-- MENU CADASTRO -->
<div class="container hidden" id="menuCadastro">
  <h2>Cadastro</h2>
  <button onclick="abrirInserir()">Inserir</button>
  <button onclick="abrirConsultar()">Consultar</button>
  <button class="btn-voltar" onclick="voltar()">Voltar</button>
</div>

<!-- INSERIR CADASTRO -->
<div class="container hidden" id="inserir">
  <h2>Inserir / Editar Funcion√°rio</h2>
  <input type="hidden" id="idEditando" />
  <input type="text" id="nome" placeholder="Nome" />
  <input type="text" id="cargo" placeholder="Cargo" />
  <button onclick="salvarCadastro()">Salvar</button>
  <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
</div>

<!-- CONSULTAR CADASTRO -->
<div class="container hidden" id="consultar">
  <h2>Consultar Funcion√°rios</h2>
  <input type="text" id="filtro" placeholder="Filtrar por nome" oninput="mostrarCadastros()" />
  <div class="lista" id="listaCadastros"></div>
  <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
</div>

<!-- MENU LAN√áAMENTO -->
<div class="container hidden" id="menuLancamento">
  <h2>Lan√ßamento</h2>
  <button onclick="abrirInserirLancamento()">Inserir</button>
  <button onclick="abrirConsultarLancamento()">Consultar</button>
  <button class="btn-voltar" onclick="voltar()">Voltar</button>
</div>

<!-- INSERIR LAN√áAMENTO -->
<div class="container hidden" id="inserirLancamento">
  <h2>Inserir / Editar Lan√ßamento</h2>
  <input type="hidden" id="idLancEditando" />
  <input list="nomesCadastradosLanc" id="nomeLanc" placeholder="Nome do Funcion√°rio" />
  <datalist id="nomesCadastradosLanc"></datalist>
  <input type="date" id="dataLanc" />
  <select id="tipoLanc">
    <option value="">Selecione Tipo</option>
    <option value="VALE">VALE</option>
    <option value="COMPRA">COMPRA</option>
  </select>
  <input type="number" id="valorLanc" placeholder="Valor" step="0.01" />
  <button onclick="salvarLancamento()">Salvar</button>
  <button class="btn-voltar" onclick="voltarLancamento()">Voltar</button>
</div>

<!-- CONSULTAR LAN√áAMENTO -->
<div class="container hidden" id="consultarLancamento">
  <h2>Consultar Lan√ßamentos</h2>
  <input type="text" id="filtroLanc" placeholder="Filtrar por nome" oninput="mostrarLancamentos()" />
  <input type="month" id="filtroMesAno" onchange="mostrarLancamentos()" />
  <div class="lista" id="listaLancamentos"></div>
  <button onclick="gerarPDFResumoLancamentos()">Gerar PDF</button>
  <button class="btn-voltar" onclick="voltarLancamento()">Voltar</button>
</div>

<!-- SDK FIREBASE + FUN√á√ïES CRUD -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push, set, update, remove, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDH9MG50ynnt4SiXGAFymBH9nXmBqLwTtU",
    authDomain: "funcionarios-7c778.firebaseapp.com",
    databaseURL: "https://funcionarios-7c778-default-rtdb.firebaseio.com",
    projectId: "funcionarios-7c778",
    storageBucket: "funcionarios-7c778.firebasestorage.app",
    messagingSenderId: "632364021109",
    appId: "1:632364021109:web:fcfaf1de66901c8a8b4f3c",
    measurementId: "G-46DKFS3LHV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.listarCadastrosArray = async function() {
    const snapshot = await get(ref(db, "cadastros"));
    if (!snapshot.exists()) return [];
    const data = snapshot.val();
    return Object.entries(data).map(([id, v]) => ({ id, nome: v.nome || "", cargo: v.cargo || "" }));
  };

  window.adicionarCadastro = async function(c) {
    const novoRef = push(ref(db, "cadastros"));
    await set(novoRef, c);
  };

  window.atualizarCadastro = async function(id, c) {
    await update(ref(db, "cadastros/" + id), c);
  };

  window.excluirCadastroFb = async function(id) {
    await remove(ref(db, "cadastros/" + id));
  };

  window.listarLancamentosArray = async function() {
    const snapshot = await get(ref(db, "lancamentos"));
    if (!snapshot.exists()) return [];
    const data = snapshot.val();
    return Object.entries(data).map(([id, v]) => ({ id, ...v }));
  };

  window.adicionarLancamento = async function(l) {
    const novoRef = push(ref(db, "lancamentos"));
    await set(novoRef, l);
  };

  window.atualizarLancamento = async function(id, l) {
    await update(ref(db, "lancamentos/" + id), l);
  };

  window.excluirLancamentoFb = async function(id) {
    await remove(ref(db, "lancamentos/" + id));
  };
</script>

<script>
/* ======================================================
   ‚ö†Ô∏è SE√á√ÉO: AVISOS E LOGIN
   ====================================================== */
function mostrarAviso(msg, campo, cor = "red") {
  const aviso = document.createElement("div");
  aviso.textContent = msg;
  aviso.style.color = cor;
  aviso.style.fontWeight = "bold";
  aviso.style.marginTop = "5px";
  campo?.after(aviso);
  setTimeout(() => aviso.remove(), 3000);
}

function fazerLogin() {
  const usuario = document.getElementById("loginUsuario").value.trim().toUpperCase();
  const senha = document.getElementById("loginSenha").value.trim();

  if (usuario === "ADMIN" && senha === "123") {
    esconderTudo();
    document.getElementById("menu").classList.remove("hidden");
  } else {
    mostrarAviso("Usu√°rio ou senha incorretos!", document.getElementById("loginSenha"));
  }
}

/* ======================================================
   üß≠ SE√á√ÉO: NAVEGA√á√ÉO ENTRE TELAS
   ====================================================== */
function esconderTudo() { document.querySelectorAll('.container').forEach(div => div.classList.add('hidden')); }
function abrirCadastro() { esconderTudo(); document.getElementById('menuCadastro').classList.remove('hidden'); }
function abrirLancamento() { esconderTudo(); document.getElementById('menuLancamento').classList.remove('hidden'); }
function voltar() { esconderTudo(); document.getElementById('menu').classList.remove('hidden'); }
function voltarCadastro() { esconderTudo(); document.getElementById('menuCadastro').classList.remove('hidden'); }
function voltarLancamento() { esconderTudo(); document.getElementById('menuLancamento').classList.remove('hidden'); }

function sair() {
  mostrarAviso("‚úÖ Voc√™ clicou no bot√£o SAIR!", null, "green");
  setTimeout(() => location.reload(), 3000);
}

/* ======================================================
   üë• SE√á√ÉO: CADASTRO DE FUNCION√ÅRIOS
   ====================================================== */
async function abrirInserir() { esconderTudo(); document.getElementById('inserir').classList.remove('hidden'); limparCamposCadastro(); }
async function abrirConsultar() { esconderTudo(); document.getElementById('consultar').classList.remove('hidden'); mostrarCadastros(); }
async function salvarCadastro() { const nome = document.getElementById('nome').value.toUpperCase(); const cargo = document.getElementById('cargo').value; const id = document.getElementById('idEditando').value; if (!nome || !cargo) return alert("Preencha tudo"); if (id) await atualizarCadastro(id, { nome, cargo }); else await adicionarCadastro({ nome, cargo }); voltarCadastro(); mostrarCadastros(); atualizarDatalistLanc(); }
async function mostrarCadastros() { const filtro = document.getElementById('filtro').value.toUpperCase(); const lista = document.getElementById('listaCadastros'); lista.innerHTML = ""; const arr = await listarCadastrosArray(); arr.filter(c => c.nome.includes(filtro)).forEach(c => { const d = document.createElement('div'); d.className = 'item'; d.innerHTML = `<span ondblclick="editarCadastro('${c.id}')"><b>${c.nome}</b> - ${c.cargo}</span> <button class='btn-excluir' onclick="excluirCadastro('${c.id}')">üóëÔ∏è</button>`; lista.appendChild(d); }); }
async function editarCadastro(id) { const arr = await listarCadastrosArray(); const c = arr.find(x => x.id === id); if (!c) return; esconderTudo(); document.getElementById('inserir').classList.remove('hidden'); document.getElementById('idEditando').value = c.id; document.getElementById('nome').value = c.nome; document.getElementById('cargo').value = c.cargo; }
async function excluirCadastro(id) { if (confirm("Excluir?")) { await excluirCadastroFb(id); mostrarCadastros(); atualizarDatalistLanc(); } }
function limparCamposCadastro() { document.getElementById('idEditando').value = ''; document.getElementById('nome').value = ''; document.getElementById('cargo').value = ''; }

/* ======================================================
   üí∞ SE√á√ÉO: LAN√áAMENTOS
   ====================================================== */
async function abrirInserirLancamento() { esconderTudo(); document.getElementById('inserirLancamento').classList.remove('hidden'); atualizarDatalistLanc(); }
async function abrirConsultarLancamento() { esconderTudo(); document.getElementById('consultarLancamento').classList.remove('hidden'); mostrarLancamentos(); }
async function salvarLancamento() { const nome = document.getElementById('nomeLanc').value.toUpperCase(); const data = document.getElementById('dataLanc').value; const tipo = document.getElementById('tipoLanc').value; const valor = parseFloat(document.getElementById('valorLanc').value); const id = document.getElementById('idLancEditando').value; if (!nome || !data || !tipo || isNaN(valor)) return alert("Preencha tudo"); if (id) await atualizarLancamento(id, { nome, data, tipo, valor }); else await adicionarLancamento({ nome, data, tipo, valor }); voltarLancamento(); mostrarLancamentos(); }
async function mostrarLancamentos() { const lista = document.getElementById('listaLancamentos'); lista.innerHTML = ""; const filtro = document.getElementById('filtroLanc').value.toUpperCase(); const mes = document.getElementById('filtroMesAno').value; let arr = await listarLancamentosArray(); if (filtro) arr = arr.filter(l => l.nome.includes(filtro)); if (mes) arr = arr.filter(l => l.data.startsWith(mes)); arr.forEach(l => { const d = document.createElement('div'); d.className = 'item'; d.innerHTML = `<span ondblclick="editarLancamento('${l.id}')"><b>${l.nome}</b> | ${l.data} | ${l.tipo} | R$ ${l.valor}</span> <button class='btn-excluir' onclick="excluirLancamento('${l.id}')">üóëÔ∏è</button>`; lista.appendChild(d); }); }
async function editarLancamento(id) { const arr = await listarLancamentosArray(); const l = arr.find(x => x.id === id); if (!l) return; esconderTudo(); document.getElementById('inserirLancamento').classList.remove('hidden'); document.getElementById('idLancEditando').value = l.id; document.getElementById('nomeLanc').value = l.nome; document.getElementById('dataLanc').value = l.data; document.getElementById('tipoLanc').value = l.tipo; document.getElementById('valorLanc').value = l.valor; }
async function excluirLancamento(id) { if (confirm("Excluir?")) { await excluirLancamentoFb(id); mostrarLancamentos(); } }
async function atualizarDatalistLanc() { const dl = document.getElementById('nomesCadastradosLanc'); dl.innerHTML = ""; const arr = await listarCadastrosArray(); arr.forEach(c => { const o = document.createElement('option'); o.value = c.nome; dl.appendChild(o); }); }

/* ======================================================
   üìÑ SE√á√ÉO: GERAR PDF
   ====================================================== */
async function gerarPDFResumoLancamentos() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const pageWidth = pdf.internal.pageSize.getWidth();

  const filtro = document.getElementById("filtroMesAno");
  const mes = filtro.value;
  if (!mes) {
    mostrarAviso("Selecione o PER√çODO (m√™s/ano) antes de gerar o PDF!", filtro);
    return;
  }

  pdf.setFontSize(14);
  pdf.text("SUPERMERCADO LEV +", pageWidth / 2, 15, { align: "center" });
  const hoje = new Date();
  const dataFormatada = hoje.toLocaleDateString("pt-BR");
  pdf.setFontSize(11);
  pdf.text(`Per√≠odo: ${mes}`, pageWidth / 2, 24, { align: "center" });
  pdf.text(`Emitido em: ${dataFormatada}`, 10, 24);

  pdf.line(10, 27, pageWidth - 10, 27);
  pdf.setFontSize(12);
  pdf.text("Nome", 10, 34);
  pdf.text("Valor", pageWidth - 10, 34, { align: "right" });
  pdf.line(10, 36, pageWidth - 10, 36);

  const lancamentos = await listarLancamentosArray();
  const filtrados = lancamentos.filter(l => l.data.startsWith(mes));
  let y = 43, total = 0;
  for (const l of filtrados) {
    pdf.text(l.nome, 10, y);
    pdf.text(`R$ ${l.valor.toFixed(2)}`, pageWidth - 10, y, { align: "right" });
    y += 8; total += l.valor;
    if (y > 280) { pdf.addPage(); y = 20; }
  }
  pdf.line(10, y, pageWidth - 10, y);
  pdf.text("TOTAL", 10, y + 8);
  pdf.text(`R$ ${total.toFixed(2)}`, pageWidth - 10, y + 8, { align: "right" });
  pdf.save(`resumo_lancamentos_${mes}.pdf`);
}
</script>
</body>
</html>
