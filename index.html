<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema Simples - Funcion√°rios</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    text-transform: uppercase;
    box-sizing: border-box;
  }

  .container {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    text-align: center;
    width: 100%;
    max-width: 380px;
    box-sizing: border-box;
  }

  h2 { margin-bottom: 20px; font-size: 1.4em; }

  input, select {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    text-transform: uppercase;
  }

  button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border: none;
    border-radius: 8px;
    background-color: #007bff;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.2s;
  }

  button:hover { background-color: #0056b3; }
  .btn-voltar { background-color: #6c757d; }
  .btn-voltar:hover { background-color: #565e64; }

  .hidden { display: none; }
  .lista { text-align: left; margin-top: 10px; max-height: 250px; overflow-y: auto; }

  .item {
    display: flex; justify-content: space-between; align-items: center;
    background: #f1f3f5; padding: 6px 8px; border-radius: 6px; margin: 4px 0;
  }

  .btn-excluir {
    width: 28px; height: 28px; border-radius: 50%;
    background-color:#dc3545; color:white; border:none; cursor:pointer;
  }

  @media (max-width: 400px) {
    h2 { font-size: 1.2em; }
    button { font-size: 15px; padding: 10px; }
  }
</style>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, set, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// Configura√ß√£o Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDH9MG50ynnt4SiXGAFymBH9nXmBqLwTtU",
  authDomain: "funcionarios-7c778.firebaseapp.com",
  databaseURL: "https://funcionarios-7c778-default-rtdb.firebaseio.com/",
  projectId: "funcionarios-7c778",
  storageBucket: "funcionarios-7c778.firebasestorage.app",
  messagingSenderId: "632364021109",
  appId: "1:632364021109:web:fcfaf1de66901c8a8b4f3c",
  measurementId: "G-46DKFS3LHV"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Fun√ß√µes auxiliares
function $(id){ return document.getElementById(id); }
function esconderTudo(){ document.querySelectorAll('.container').forEach(div=>div.classList.add('hidden')); }
function mostrar(id){ esconderTudo(); $(id).classList.remove('hidden'); }

/* ---------------- LOGIN ---------------- */
function fazerLogin(){
  const usuario = ($('loginUsuario').value || '').trim().toUpperCase();
  const senha = ($('loginSenha').value || '').trim();
  if(usuario === 'ADMIN' && senha === '1234'){
    mostrar('menu');
  } else {
    alert('Usu√°rio ou senha incorretos!');
    focarLogin();
  }
}

function sair(){
  mostrar('loginContainer');
  focarLogin();
}

/* ---------------- CADASTRO ---------------- */
function abrirCadastro(){ mostrar('menuCadastro'); }
function abrirInserir(){ mostrar('inserir'); limparCamposCadastro(); }
function abrirConsultar(){ mostrar('consultar'); carregarCadastros(); }
function voltarCadastro(){ mostrar('menuCadastro'); }

async function salvarCadastro(){
  const nome = $('nome').value.trim().toUpperCase();
  const cargo = $('cargo').value.trim().toUpperCase();
  if(!nome || !cargo) return alert('Preencha todos os campos.');

  const idEdit = $('idEditando').value;
  const cadRef = ref(db, 'funcionarios');
  
  if(idEdit){
    await update(ref(db, 'funcionarios/' + idEdit), { nome, cargo });
  } else {
    const novo = push(cadRef);
    await set(novo, { nome, cargo });
  }

  limparCamposCadastro();
  voltarCadastro();
}

function limparCamposCadastro(){
  $('idEditando').value = '';
  $('nome').value = '';
  $('cargo').value = '';
}

function carregarCadastros(){
  const lista = $('listaCadastros');
  const filtro = ($('filtro').value || '').toUpperCase();
  lista.innerHTML = '';

  onValue(ref(db, 'funcionarios'), snapshot => {
    lista.innerHTML = '';
    snapshot.forEach(child => {
      const id = child.key;
      const { nome, cargo } = child.val();
      if(filtro && !nome.includes(filtro)) return;
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span><strong>${nome}</strong> - ${cargo}</span>
        <button class="btn-excluir" onclick="excluirCadastro('${id}')">üóëÔ∏è</button>`;
      lista.appendChild(div);
    });
  });
}

async function excluirCadastro(id){
  if(!confirm('Excluir este funcion√°rio?')) return;
  await remove(ref(db, 'funcionarios/' + id));
}

/* ---------------- LAN√áAMENTO ---------------- */
function abrirLancamento(){ mostrar('menuLancamento'); }
function voltarLancamento(){ mostrar('menuLancamento'); }
function abrirInserirLancamento(){ mostrar('inserirLancamento'); atualizarNomesLanc(); }
function abrirConsultarLancamento(){ mostrar('consultarLancamento'); carregarLancamentos(); }

async function salvarLancamento(){
  const nome = $('nomeLanc').value.trim().toUpperCase();
  const data = $('dataLanc').value;
  const tipo = $('tipoLanc').value;
  const valor = parseFloat($('valorLanc').value);
  if(!nome || !data || !tipo || isNaN(valor)) return alert('Preencha todos os campos.');

  const idEdit = $('idLancEditando').value;
  const lancRef = ref(db, 'lancamentos');

  if(idEdit){
    await update(ref(db, 'lancamentos/' + idEdit), { nome, data, tipo, valor });
  } else {
    const novo = push(lancRef);
    await set(novo, { nome, data, tipo, valor });
  }

  limparCamposLancamento();
  voltarLancamento();
}

function limparCamposLancamento(){
  $('idLancEditando').value=''; $('nomeLanc').value=''; $('dataLanc').value='';
  $('tipoLanc').value=''; $('valorLanc').value='';
}

function atualizarNomesLanc(){
  const datalist = $('nomesCadastradosLanc');
  datalist.innerHTML = '';
  get(ref(db, 'funcionarios')).then(snapshot => {
    snapshot.forEach(child => {
      const opt = document.createElement('option');
      opt.value = child.val().nome;
      datalist.appendChild(opt);
    });
  });
}

function carregarLancamentos(){
  const lista = $('listaLancamentos');
  const filtroNome = ($('filtroLanc').value || '').toUpperCase();
  const filtroMesAno = $('filtroMesAno').value;
  lista.innerHTML = '';

  onValue(ref(db, 'lancamentos'), snapshot => {
    lista.innerHTML = '';
    snapshot.forEach(child => {
      const id = child.key;
      const l = child.val();
      if(filtroNome && !l.nome.includes(filtroNome)) return;
      if(filtroMesAno && !l.data.startsWith(filtroMesAno)) return;
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span><strong>${l.nome}</strong> | ${l.data} | ${l.tipo} | R$ ${l.valor.toFixed(2).replace('.', ',')}</span>
        <button class="btn-excluir" onclick="excluirLancamento('${id}')">üóëÔ∏è</button>`;
      lista.appendChild(div);
    });
  });
}

async function excluirLancamento(id){
  if(!confirm('Excluir este lan√ßamento?')) return;
  await remove(ref(db, 'lancamentos/' + id));
}

/* ---------------- PDF ---------------- */
async function gerarPDFResumoLancamentos(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const pageWidth = pdf.internal.pageSize.getWidth();
  let y = 20;

  pdf.setFontSize(14);
  pdf.text("SUPERMERCADO LEV +", pageWidth/2, y, { align: "center" });
  y += 10;

  const snapshot = await get(ref(db, 'lancamentos'));
  const resumo = {};
  snapshot.forEach(child => {
    const l = child.val();
    resumo[l.nome] = (resumo[l.nome] || 0) + l.valor;
  });

  pdf.setFontSize(12);
  for(const nome in resumo){
    const valor = resumo[nome];
    pdf.text(`${nome} ........... R$ ${valor.toFixed(2).replace('.', ',')}`, 10, y);
    y += 8;
  }

  const total = Object.values(resumo).reduce((a,b)=>a+b,0);
  y += 5;
  pdf.text(`TOTAL GERAL ........... R$ ${total.toFixed(2).replace('.', ',')}`, 10, y);
  pdf.save("RESUMO_LANCAMENTOS.pdf");
}

/* ---------------- Foco autom√°tico no login ---------------- */
function focarLogin(){
  setTimeout(()=> $('loginUsuario').focus(), 200);
}
window.addEventListener('load', focarLogin);
</script>
</head>
<body>

<!-- LOGIN -->
<div class="container" id="loginContainer">
  <h2>Login</h2>
  <input type="text" id="loginUsuario" placeholder="Usu√°rio" />
  <input type="password" id="loginSenha" placeholder="Senha" />
  <button onclick="fazerLogin()">Entrar</button>
</div>

<!-- MENU -->
<div class="container hidden" id="menu">
  <h2>Menu Principal</h2>
  <button onclick="abrirCadastro()">Cadastro</button>
  <button onclick="abrirLancamento()">Lan√ßamento</button>
  <button onclick="sair()" id="btnSair">Sair</button>
</div>

<!-- CADASTRO -->
<div class="container hidden" id="menuCadastro">
  <h2>Cadastro</h2>
  <button onclick="abrirInserir()">Inserir</button>
  <button onclick="abrirConsultar()">Consultar</button>
  <button class="btn-voltar" onclick="mostrar('menu')">Voltar</button>
</div>

<div class="container hidden" id="inserir">
  <h2>Inserir Funcion√°rio</h2>
  <input type="hidden" id="idEditando" />
  <input type="text" id="nome" placeholder="Nome" />
  <input type="text" id="cargo" placeholder="Cargo" />
  <button onclick="salvarCadastro()">Salvar</button>
  <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
</div>

<div class="container hidden" id="consultar">
  <h2>Consultar Funcion√°rios</h2>
  <input type="text" id="filtro" placeholder="Filtrar por nome" oninput="carregarCadastros()" />
  <div class="lista" id="listaCadastros"></div>
  <button class="btn-voltar" onclick="voltarCadastro()">Voltar</button>
</div>

<!-- LAN√áAMENTOS -->
<div class="container hidden" id="menuLancamento">
  <h2>Lan√ßamento</h2>
  <button onclick="abrirInserirLancamento()">Inserir</button>
  <button onclick="abrirConsultarLancamento()">Consultar</button>
  <button class="btn-voltar" onclick="mostrar('menu')">Voltar</button>
</div>

<div class="container hidden" id="inserirLancamento">
  <h2>Inserir Lan√ßamento</h2>
  <input type="hidden" id="idLancEditando" />
  <input list="nomesCadastradosLanc" id="nomeLanc" placeholder="Nome do Funcion√°rio" />
  <datalist id="nomesCadastradosLanc"></datalist>
  <input type="date" id="dataLanc" />
  <select id="tipoLanc">
    <option value="">Selecione Tipo</option>
    <option value="VALE">VALE</option>
    <option value="COMPRA">COMPRA</option>
  </select>
  <input type="number" id="valorLanc" placeholder="Valor" step="0.01" />
  <button onclick="salvarLancamento()">Salvar</button>
  <button class="btn-voltar" onclick="voltarLancamento()">Voltar</button>
</div>

<div class="container hidden" id="consultarLancamento">
  <h2>Consultar Lan√ßamentos</h2>
  <input type="text" id="filtroLanc" placeholder="Filtrar por nome" oninput="carregarLancamentos()" />
  <input type="month" id="filtroMesAno" onchange="carregarLancamentos()" />
  <div class="lista" id="listaLancamentos"></div>
  <button onclick="gerarPDFResumoLancamentos()">Gerar PDF</button>
  <button class="btn-voltar" onclick="voltarLancamento()">Voltar</button>
</div>

</body>
</html>
